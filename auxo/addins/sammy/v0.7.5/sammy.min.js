(function(n){typeof define=="function"&&define.amd?define(["jquery"],n):jQuery.sammy=window.Sammy=n(jQuery)})(function(n){var t,p="([^/]+)",s=/:([\w\d]+)/g,c=/\?([^#]*)?$/,r=function(n){return Array.prototype.slice.call(n)},i=function(n){return Object.prototype.toString.call(n)==="[object Function]"},u=function(n){return Object.prototype.toString.call(n)==="[object Array]"},l=function(n){return Object.prototype.toString.call(n)==="[object RegExp]"},e=function(n){return decodeURIComponent((n||"").replace(/\+/g," "))},a=encodeURIComponent,v=function(n){return String(n).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},f=function(n){return function(){return this.route.apply(this,[n].concat(Array.prototype.slice.call(arguments)))}},h={},o=!!(window.history&&history.pushState),y=[];return t=function(){var u=r(arguments),f,e;return(t.apps=t.apps||{},u.length===0||u[0]&&i(u[0]))?t.apply(t,["body"].concat(u)):typeof(e=u.shift())=="string"?(f=t.apps[e]||new t.Application,f.element_selector=e,u.length>0&&n.each(u,function(n,t){f.use(t)}),f.element_selector!=e&&delete t.apps[e],t.apps[f.element_selector]=f,f):void 0},t.VERSION="0.7.5",t.addLogger=function(n){y.push(n)},t.log=function(){var i=r(arguments);i.unshift("["+Date()+"]");n.each(y,function(n,r){r.apply(t,i)})},typeof console!="undefined"?typeof window.console.log=="function"&&i(window.console.log.apply)?t.addLogger(function(){window.console.log.apply(window.console,arguments)}):t.addLogger(function(){window.console.log(arguments)}):typeof console!="undefined"&&t.addLogger(function(){console.log.apply(console,arguments)}),n.extend(t,{makeArray:r,isFunction:i,isArray:u}),t.Object=function(t){return n.extend(this,t||{})},n.extend(t.Object.prototype,{escapeHTML:v,h:v,toHash:function(){var t={};return n.each(this,function(n,r){i(r)||(t[n]=r)}),t},toHTML:function(){var t="";return n.each(this,function(n,r){i(r)||(t+="<strong>"+n+"<\/strong> "+r+"<br />")}),t},keys:function(n){var t=[];for(var r in this)i(this[r])&&n||t.push(r);return t},has:function(t){return this[t]&&n.trim(this[t].toString())!==""},join:function(){var n=r(arguments),t=n.shift();return n.join(t)},log:function(){t.log.apply(t,arguments)},toString:function(t){var r=[];return n.each(this,function(n,u){(!i(u)||t)&&r.push('"'+n+'": '+u.toString())}),"Sammy.Object: {"+r.join(",")+"}"}}),t.targetIsThisWindow=function(t,i){var u=n(t.target).closest(i),r;return u.length===0?!0:(r=u.attr("target"),!r||r===window.name||r==="_self")?!0:r==="_blank"?!1:r==="top"&&window===window.top?!0:!1},t.DefaultLocationProxy=function(n,t){this.app=n;this.is_native=!1;this.has_history=o;this._startPolling(t)},t.DefaultLocationProxy.fullPath=function(n){var t=n.toString().match(/^[^#]*(#.+)$/),i=t?t[1]:"";return[n.pathname,n.search,i].join("")},n.extend(t.DefaultLocationProxy.prototype,{bind:function(){var u=this,r=this.app,i=t.DefaultLocationProxy;n(window).bind("hashchange."+this.app.eventNamespace(),function(n,t){u.is_native!==!1||t||(u.is_native=!0,window.clearInterval(i._interval),i._interval=null);r.trigger("location-changed")});o&&!r.disable_push_state&&(n(window).bind("popstate."+this.app.eventNamespace(),function(){r.trigger("location-changed")}),n(document).delegate("a","click.history-"+this.app.eventNamespace(),function(n){if(!n.isDefaultPrevented()&&!n.metaKey&&!n.ctrlKey){var f=i.fullPath(this),e=this.hostname?this.hostname:function(n){var t=document.createElement("a");return t.href=n.href,t.hostname}(this);if(e==window.location.hostname&&r.lookupRoute("get",f)&&t.targetIsThisWindow(n,"a"))return n.preventDefault(),u.setLocation(f),!1}}));i._bindings||(i._bindings=0);i._bindings++},unbind:function(){n(window).unbind("hashchange."+this.app.eventNamespace());n(window).unbind("popstate."+this.app.eventNamespace());n(document).undelegate("a","click.history-"+this.app.eventNamespace());t.DefaultLocationProxy._bindings--;t.DefaultLocationProxy._bindings<=0&&(window.clearInterval(t.DefaultLocationProxy._interval),t.DefaultLocationProxy._interval=null)},getLocation:function(){return t.DefaultLocationProxy.fullPath(window.location)},setLocation:function(n){if(/^([^#\/]|$)/.test(n)&&(n=o&&!this.app.disable_push_state?"/"+n:"#!/"+n),n!=this.getLocation())if(o&&!this.app.disable_push_state&&/^\//.test(n))history.pushState({path:n},window.title,n),this.app.trigger("location-changed");else return window.location=n},_startPolling:function(i){var u=this,r;t.DefaultLocationProxy._interval||(i||(i=10),r=function(){var i=u.getLocation();(typeof t.DefaultLocationProxy._last_location=="undefined"||i!=t.DefaultLocationProxy._last_location)&&window.setTimeout(function(){n(window).trigger("hashchange",[!0])},0);t.DefaultLocationProxy._last_location=i},r(),t.DefaultLocationProxy._interval=window.setInterval(r,i))}}),t.Application=function(n){var r=this;this.routes={};this.listeners=new t.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+"-"+parseInt(Math.random()*1e3,10);this.context_prototype=function(){t.EventContext.apply(this,arguments)};this.context_prototype.prototype=new t.EventContext;i(n)&&n.apply(this,[this]);this._location_proxy||this.setLocationProxy(new t.DefaultLocationProxy(this,this.run_interval_every));this.debug&&this.bindToAllEvents(function(n,t){r.log(r.toString(),n.cleaned_type,t||{})})},t.Application.prototype=n.extend({},t.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,disable_push_state:!1,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(t){return t?n(this.element_selector).find(t):n(this.element_selector)},use:function(){var u=r(arguments),n=u.shift(),f=n||"";try{u.unshift(this);typeof n=="string"&&(f="Sammy."+n,n=t[n]);n.apply(this,u)}catch(e){typeof n=="undefined"?this.error("Plugin Error: called use() but plugin ("+f.toString()+") is not defined",e):i(n)?this.error("Plugin Error",e):this.error("Plugin Error: called use() but '"+f.toString()+"' is not a function",e)}return this},setLocationProxy:function(n){var t=this._location_proxy;this._location_proxy=n;this.isRunning()&&(t&&t.unbind(),this._location_proxy.bind())},log:function(){t.log.apply(t,Array.prototype.concat.apply([this.element_selector],arguments))},route:function(t,r){var f=this,o=[],e,h,u=Array.prototype.slice.call(arguments,2);if(u.length===0&&i(r)&&(u=[r],r=t,t="any"),t=t.toLowerCase(),r.constructor==String){for(s.lastIndex=0;(h=s.exec(r))!==null;)o.push(h[1]);r=new RegExp(r.replace(s,p)+"$")}return n.each(u,function(n,t){typeof t=="string"&&(u[n]=f[t])}),e=function(n){var t={verb:n,path:r,callback:u,param_names:o};f.routes[n]=f.routes[n]||[];f.routes[n].push(t)},t==="any"?n.each(this.ROUTE_VERBS,function(n,t){e(t)}):e(t),this},get:f("get"),post:f("post"),put:f("put"),del:f("delete"),any:f("any"),mapRoutes:function(t){var i=this;return n.each(t,function(n,t){i.route.apply(i,t)}),this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(n,t,i){var r=this,u;return typeof i=="undefined"&&(i=t),u=function(){var t,u,n;t=arguments[0];n=arguments[1];n&&n.context?(u=n.context,delete n.context):u=new r.context_prototype(r,"bind",t.type,n,t.target);t.cleaned_type=t.type.replace(r.eventNamespace(),"");i.apply(u,[t,n])},this.listeners[n]||(this.listeners[n]=[]),this.listeners[n].push(u),this.isRunning()&&this._listen(n,u),this},trigger:function(n,t){return this.$element().trigger([n,this.eventNamespace()].join("."),[t]),this},refresh:function(){return this.last_location=null,this.trigger("location-changed"),this},before:function(n,t){return i(n)&&(t=n,n={}),this.befores.push([n,t]),this},after:function(n){return this.bind("event-context-after",n)},around:function(n){return this.arounds.push(n),this},onComplete:function(n){return this._onComplete=n,this},isRunning:function(){return this._running},helpers:function(t){return n.extend(this.context_prototype.prototype,t),this},helper:function(n,t){return this.context_prototype.prototype[n]=t,this},run:function(i){if(this.isRunning())return!1;var r=this;return n.each(this.listeners.toHash(),function(t,i){n.each(i,function(n,i){r._listen(t,i)})}),this.trigger("run",{start_url:i}),this._running=!0,this.last_location=null,/\#(.+)/.test(this.getLocation())||typeof i=="undefined"||this.setLocation(i),this._checkLocation(),this._location_proxy.bind(),this.bind("location-changed",function(){r._checkLocation()}),this.bind("submit",function(i){if(!t.targetIsThisWindow(i,"form"))return!0;var u=r._checkFormSubmission(n(i.target).closest("form"));return u===!1?i.preventDefault():!1}),n(window).bind("unload",function(){r.unload()}),this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var t=this;return this.trigger("unload"),this._location_proxy.unbind(),this.$element().unbind("submit").removeClass(t.eventNamespace()),n.each(this.listeners.toHash(),function(i,r){n.each(r,function(n,r){t._unlisten(i,r)})}),this._running=!1,this},destroy:function(){return this.unload(),delete t.apps[this.element_selector],this},bindToAllEvents:function(t){var i=this;return n.each(this.APP_EVENTS,function(n,r){i.bind(r,t)}),n.each(this.listeners.keys(!0),function(r,u){n.inArray(u,i.APP_EVENTS)==-1&&i.bind(u,t)}),this},routablePath:function(n){return n.replace(c,"")},lookupRoute:function(n,t){var e=this,u=!1,i=0,f,r;if(typeof this.routes[n]!="undefined")for(f=this.routes[n].length;i<f;i++)if(r=this.routes[n][i],e.routablePath(t).match(r.path)){u=r;break}return u},runRoute:function(t,i,r,u){var s=this,f=this.lookupRoute(t,i),o,c,y,l,a,h,v,p;if(this.debug&&this.log("runRoute",[t,i].join(" ")),this.trigger("run-route",{verb:t,path:i,params:r}),typeof r=="undefined"&&(r={}),n.extend(r,this._parseQueryString(i)),f){this.trigger("route-found",{route:f});(v=f.path.exec(this.routablePath(i)))!==null&&(v.shift(),n.each(v,function(n,t){f.param_names[n]?r[f.param_names[n]]=e(t):(r.splat||(r.splat=[]),r.splat.push(e(t)))}));o=new this.context_prototype(this,t,i,r,u);y=this.arounds.slice(0);l=this.befores.slice(0);h=[o];r.splat&&(h=h.concat(r.splat));c=function(){for(var n,t,i;l.length>0;)if(a=l.shift(),s.contextMatchesOptions(o,a[0])&&(n=a[1].apply(o,[o]),n===!1))return!1;return s.last_route=f,o.trigger("event-context-before",{context:o}),typeof f.callback=="function"&&(f.callback=[f.callback]),f.callback&&f.callback.length&&(t=-1,i=function(){t++;f.callback[t]?n=f.callback[t].apply(o,h):s._onComplete&&typeof(s._onComplete==="function")&&s._onComplete(o)},h.push(i),i()),o.trigger("event-context-after",{context:o}),n};n.each(y.reverse(),function(n,t){var i=c;c=function(){return t.apply(o,[i])}});try{p=c()}catch(w){this.error(["500 Error",t,i].join(" "),w)}return p}return this.notFound(t,i)},contextMatchesOptions:function(t,i,r){var f=i,h,e,a,v,c,o,s;if((typeof f=="string"||l(f))&&(f={path:f}),typeof r=="undefined"&&(r=!0),n.isEmptyObject(f))return!0;if(u(f.path)){for(h=[],e=0,v=f.path.length;e<v;e+=1)a=n.extend({},f,{path:f.path[e]}),h.push(this.contextMatchesOptions(t,a));return c=n.inArray(!0,h)>-1?!0:!1,r?c:!c}return f.only?this.contextMatchesOptions(t,f.only,!0):f.except?this.contextMatchesOptions(t,f.except,!1):(o=!0,s=!0,f.path&&(l(f.path)||(f.path=new RegExp(f.path.toString()+"$")),o=f.path.test(t.path)),f.verb&&(s=typeof f.verb=="string"?f.verb===t.verb:f.verb.indexOf(t.verb)>-1),r?s&&o:!(s&&o))},getLocation:function(){return this._location_proxy.getLocation()},setLocation:function(n){return this._location_proxy.setLocation(n)},swap:function(n,t){var r=this.$element().html(n);return i(t)&&t(n),r},templateCache:function(n,t){return typeof t!="undefined"?h[n]=t:h[n]},clearTemplateCache:function(){return h={}},notFound:function(n,t){var i=this.error(["404 Not Found",n,t].join(" "));return n==="get"?i:!0},error:function(n,t){if(t||(t=new Error),t.message=[n,t.message].join(" "),this.trigger("error",{message:t.message,error:t}),this.raise_errors)throw t;else this.log(t.message,t)},_checkLocation:function(){var n,t;return n=this.getLocation(),this.last_location&&this.last_location[0]=="get"&&this.last_location[1]==n||(this.last_location=["get",n],t=this.runRoute("get",n)),t},_getFormVerb:function(t){var u=n(t),i,r;return r=u.find('input[name="_method"]'),r.length>0&&(i=r.val()),i||(i=u[0].getAttribute("method")),i&&i!==""||(i="get"),n.trim(i.toString().toLowerCase())},_checkFormSubmission:function(t){var i,r,f,u,e;return this.trigger("check-form-submission",{form:t}),i=n(t),r=i.attr("action")||"",f=this._getFormVerb(i),this.debug&&this.log("_checkFormSubmission",i,r,f),f==="get"?(u=this._serializeFormParams(i),u!==""&&(r+="?"+u),this.setLocation(r),e=!1):(u=n.extend({},this._parseFormParams(i)),e=this.runRoute(f,r,u,t.get(0))),typeof e=="undefined"?!1:e},_serializeFormParams:function(n){var r="",t=n.serializeArray(),i;if(t.length>0)for(r=this._encodeFormPair(t[0].name,t[0].value),i=1;i<t.length;i++)r=r+"&"+this._encodeFormPair(t[i].name,t[i].value);return r},_encodeFormPair:function(n,t){return a(n)+"="+a(t)},_parseFormParams:function(n){for(var i={},r=n.serializeArray(),t=0;t<r.length;t++)i=this._parseParamPair(i,r[t].name,r[t].value);return i},_parseQueryString:function(n){var r={},t,u,f,i;if(t=n.match(c),t&&t[1])for(u=t[1].split("&"),i=0;i<u.length;i++)f=u[i].split("="),r=this._parseParamPair(r,e(f[0]),e(f[1]||""));return r},_parseParamPair:function(n,t,i){return typeof n[t]!="undefined"?u(n[t])?n[t].push(i):n[t]=[n[t],i]:n[t]=i,n},_listen:function(n,t){return this.$element().bind([n,this.eventNamespace()].join("."),t)},_unlisten:function(n,t){return this.$element().unbind([n,this.eventNamespace()].join("."),t)}}),t.RenderContext=function(n){this.event_context=n;this.callbacks=[];this.previous_content=null;this.content=null;this.next_engine=!1;this.waiting=!1},t.RenderContext.prototype=n.extend({},t.Object.prototype,{then:function(n){var r,t;if(!i(n))if(typeof n=="string"&&n in this.event_context)r=this.event_context[n],n=function(n){return r.apply(this.event_context,[n])};else return this;return t=this,this.waiting?this.callbacks.push(n):(this.wait(),window.setTimeout(function(){var i=n.apply(t,[t.content,t.previous_content]);i!==!1&&t.next(i)},0)),this},wait:function(){this.waiting=!0},next:function(n){this.waiting=!1;typeof n!="undefined"&&(this.previous_content=this.content,this.content=n);this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(t,r,u){var f=this;return this.then(function(){var e,s,o;return(i(r)?(u=r,r={}):r=n.extend({},r),u&&this.then(u),typeof t=="string")?(o=t.match(/\.json(\?|$)/)||r.json,e=o?r.cache===!0:r.cache!==!1,f.next_engine=f.event_context.engineFor(t),delete r.cache,delete r.json,r.engine&&(f.next_engine=r.engine,delete r.engine),e&&(s=this.event_context.app.templateCache(t)))?s:(this.wait(),n.ajax(n.extend({url:t,data:{},dataType:o?"json":"text",type:"get",success:function(n){e&&f.event_context.app.templateCache(t,n);f.next(n)}},r)),!1):t.nodeType?t.innerHTML:t.selector?(f.next_engine=t.attr("data-engine"),r.clone===!1?t.remove()[0].innerHTML.toString():t[0].innerHTML.toString()):void 0})},loadPartials:function(n){var t;if(n){this.partials=this.partials||{};for(t in n)(function(t,i){t.load(n[i]).then(function(n){this.partials[i]=n})})(this,t)}return this},render:function(n,t,r,u){return i(n)&&!t?this.then(n):(i(t)?(u=r,r=t,t=null):r&&!i(r)&&(u=r,r=null),this.loadPartials(u).load(n).interpolate(t,n).then(r))},partial:function(n,t,r,u){return i(r)?this.render(n,t,u).swap(r):i(t)?this.render(n,{},r).swap(t):this.render(n,t,r).swap()},send:function(){var t=this,n=r(arguments),i=n.shift();return u(n[0])&&(n=n[0]),this.then(function(){return n.push(function(n){t.next(n)}),t.wait(),i.apply(i,n),!1})},collect:function(t,r,u){var e=this,f=function(){i(t)&&(r=t,t=this.content);var u=[],f=!1;return n.each(t,function(n,t){var i=r.apply(e,[n,t]);return i.jquery&&i.length==1&&(i=i[0],f=!0),u.push(i),i}),f?u:u.join("")};return u?f():this.then(f)},renderEach:function(t,i,r,f){return u(i)&&(f=r,r=i,i=null),this.load(t).then(function(e){var o=this;if(r||(r=u(this.previous_content)?this.previous_content:[]),f)n.each(r,function(n,r){var u={},s=this.next_engine||t;i?u[i]=r:u=r;f(r,o.event_context.interpolate(e,u,s))});else return this.collect(r,function(n,r){var u={},f=this.next_engine||t;return i?u[i]=r:u=r,this.event_context.interpolate(e,u,f)},!0)})},interpolate:function(n,t,i){var r=this;return this.then(function(u,f){!n&&f&&(n=f);this.next_engine&&(t=this.next_engine,this.next_engine=!1);var e=r.event_context.interpolate(u,n,t,this.partials);return i?f+e:e})},swap:function(n){return this.then(function(t){return this.event_context.swap(t,n),t}).trigger("changed",{})},appendTo:function(t){return this.then(function(i){n(t).append(i)}).trigger("changed",{})},prependTo:function(t){return this.then(function(i){n(t).prepend(i)}).trigger("changed",{})},replace:function(t){return this.then(function(i){n(t).html(i)}).trigger("changed",{})},trigger:function(n,t){return this.then(function(i){return typeof t=="undefined"&&(t={content:i}),this.event_context.trigger(n,t),i})}}),t.EventContext=function(n,i,r,u,f){this.app=n;this.verb=i;this.path=r;this.params=new t.Object(u);this.target=f},t.EventContext.prototype=n.extend({},t.Object.prototype,{$element:function(){return this.app.$element(r(arguments).shift())},engineFor:function(n){var t=this,r;return i(n)?n:(n=(n||t.app.template_engine).toString(),(r=n.match(/\.([^\.\?\#]+)(\?|$)/))&&(n=r[1]),n&&i(t[n]))?t[n]:t.app.template_engine?this.engineFor(t.app.template_engine):function(n){return n}},interpolate:function(n,t,i,r){return this.engineFor(i).apply(this,[n,t,r])},render:function(n,i,r,u){return new t.RenderContext(this).render(n,i,r,u)},renderEach:function(n,i,r,u){return new t.RenderContext(this).renderEach(n,i,r,u)},load:function(n,i,r){return new t.RenderContext(this).load(n,i,r)},loadPartials:function(n){return new t.RenderContext(this).loadPartials(n)},partial:function(n,i,r,u){return new t.RenderContext(this).partial(n,i,r,u)},send:function(){var n=new t.RenderContext(this);return n.send.apply(n,arguments)},redirect:function(){var t,i=r(arguments),l=this.app.getLocation(),o=i.length,e;if(o>1){for(var u=0,s=[],h=[],f={},c=!1;u<o;u++)typeof i[u]=="string"?s.push(i[u]):(n.extend(f,i[u]),c=!0);if(t=s.join("/"),c){for(e in f)h.push(this.app._encodeFormPair(e,f[e]));t+="?"+h.join("&")}}else t=i[0];this.trigger("redirect",{to:t});this.app.last_location=[this.verb,this.path];this.app.setLocation(t);new RegExp(t).test(l)&&this.app.trigger("location-changed")},trigger:function(n,t){return typeof t=="undefined"&&(t={}),t.context||(t.context=this),this.app.trigger(n,t)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(n,t){return this.app.swap(n,t)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(t){return n.parseJSON(t)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}}),t});
