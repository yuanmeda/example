"use strict";var CloudAtlas=function(){function e(){this.sessionList=[];this.eventList=[];this.errorList=[];this.merge=function(t){if(t){if(t.sessionList.length>0){var n=t.sessionList.length;for(var i=0;i<n;i++){var r=t.sessionList[i];if(r&&r.id){var s=e.apply(this,[r]);if(s===null){this.sessionList.push(r)}else{if(r.end>s.end){s.end=r.end}}}}}if(t.eventList&&t.eventList.length>0){this.eventList=this.eventList.concat(t.eventList)}if(t.errorList&&t.errorList.length>0){this.errorList=this.errorList.concat(t.errorList)}}};function e(e){var t=this.sessionList.length;for(var n=0;n<t;n++){var i=this.sessionList[n];if(e.id===i.id){return i}}return null}this.hasValidData=function(){return this.sessionList.length>0||this.eventList.length>0||this.errorList.length>0}}function t(e,t,n,i,r,s,o){this.id=e;this.start=t;this.end=n;this.userId=i;this.appVer=r;this.ip=s;this.activityId=o;this.equals=function(e){if(this===e)return true;if(e===null||this.constructor!==e.constructor)return false;if(this.id!==e.id)return false;if(this.start!==e.start)return false;if(this.end!==e.end)return false;if(this.userId!==e.userId)return false;if(this.appVer!==e.appVer)return false;if(this.activityId!==e.activityId)return false;return this.ip===e.ip}}function n(e,t,n,i){this.appVer=e;this.userId=t;this.sessionId=n;this.ip=i}var i="ca_label";var r="ca_int_value";function s(e,t,n,i,r,s){this.id=e;this.value=t;this.time=n;this.userId=i;this.appVer=r;this.activityId=s;this.equals=function(e){if(this===e)return true;if(e===null||this.constructor!==e.constructor)return false;if(this.id!==e.id)return false;if(this.value!==e.value)return false;if(this.time!==e.time)return false;if(this.userId!==e.userId)return false;if(this.activityId!==e.activityId)return false;return this.appVer!==e.appVer}}var o=0;function a(e,t,n,i,r){this.type=e;this.msg=t;this.time=n;this.appVer=i;this.activityId=r;this.equals=function(e){if(this===e)return true;if(e===null||this.constructor!==e.constructor)return false;if(this.type!==e.type)return false;if(this.msg!==e.msg)return false;if(this.time!==e.time)return false;if(this.activityId!==e.activityId)return false;return this.appVer!==event.appVer}}var u=false;function f(e){u=e}var l=false;var c="[CloudAtlas] ";var v=window.console||function(){var e={};e.log=e.warn=e.debug=e.info=e.error=e.time=e.dir=e.profile=e.clear=e.exception=e.trace=e.assert=function(){};return e}();function p(e){l=e}function d(e){if(l){v.log(c+e)}}function h(e){if(l){v.warn(c+e)}}function g(e,t){v.error(c+e+(t?"\nerror = "+t:""))}var y="sdk_ver";var I="current";var w="pending";var m="sending";var L="current_env";var x="device_id";var b=localStorage;function S(e){if(b){b.setItem(y,e)}}function _(){if(b){return b.getItem(y)}else{return null}}function V(e){if(b){b.setItem(x,e)}}function F(){if(b){return b.getItem(x)}else{return null}}var T;function A(){if(!T){M()}return T}function M(){T=C()}var N,O;function D(e,t){N=e;O=t}function E(){return O}function q(){return N}function C(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function j(e){var t,n,i,r,s,o=e.length,a=0;for(r=0;r<o;r++){n=e.charCodeAt(r);if((n&64512)===55296&&r+1<o){i=e.charCodeAt(r+1);if((i&64512)===56320){n=65536+(n-55296<<10)+(i-56320);r++}}a+=n<128?1:n<2048?2:n<65536?3:4}t=new Uint8Array(a);for(s=0,r=0;s<a;r++){n=e.charCodeAt(r);if((n&64512)===55296&&r+1<o){i=e.charCodeAt(r+1);if((i&64512)===56320){n=65536+(n-55296<<10)+(i-56320);r++}}if(n<128){t[s++]=n}else if(n<2048){t[s++]=192|n>>>6;t[s++]=128|n&63}else if(n<65536){t[s++]=224|n>>>12;t[s++]=128|n>>>6&63;t[s++]=128|n&63}else{t[s++]=240|n>>>18;t[s++]=128|n>>>12&63;t[s++]=128|n>>>6&63;t[s++]=128|n&63}}return t}var X;function R(){return X}function U(){var e=F()||"{}";var t;try{t=JSON.parse(e)}catch(e){g("Resolve deviceInfo failed",e)}if(t&&t.deviceId){X=t.deviceId;d("Resolve exist deviceId : "+X)}else{X=C();V(JSON.stringify({deviceId:X}));d("No exist deviceId, generate one : "+X)}}function z(){var e=new Date;return e.getTime()}function H(e){function t(e){var t=Math.abs(Math.floor(e));return(t<10?"0":"")+t}function n(e){var n=-e;var i=n>=0?"+":"-";return i+t(e/60)+t(e%60)}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+"T"+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())+n(e.getTimezoneOffset())}var k="bussiness_type";var P="properties";var B="user_id";var J="device_id";var K="create_time";var Y="session_ip";var Z="function_id";var G="app_ver";var Q="login";var W="activity_id";var $="cloud-atlas-web-sdk";var ee=null;function te(e,t){var n=e.length;var i=t.length;if(n!==i){return false}for(var r=0;r<n;r++){if(e[r]!==t[r]){return false}}return true}function ne(e){if(window.Uint8Array){var t=new Uint8Array([31,139,8,0,0,0,0,0,0,3,75,206,201,47,77,209,77,44,201,73,44,214,45,79,77,210,45,78,201,6,0,249,255,225,61,19,0,0,0]);if(e){var n=j($);var i=e(n);if(te(t,i)){ee=e}else{throw"Invalid gzip function"}}else{d("Not to use gzip compress")}}else{d("Browser does not support the Unit8Array , will not to use gzip compress")}}function ie(){if(ee){return true}else{return false}}function re(e){var t={};t["body"]=JSON.parse(e);var n={};n["Content-type"]="application/json";t["head"]=n;return JSON.stringify(t)}function se(e){var t=e.length;var n=j(e);var i=ee(n);var r=i.length;d("origin: "+t+"，after compress："+r);return i}function oe(e){var t=A();var n=R();var s=[];var o={data:s};var a=e.sessionList.length;for(var u=0;u<a;u++){var f=e.sessionList[u];var l={};l[k]=Q;var c={};c[Z]=21;c[K]=H(new Date(f.start));if(f.userId){c[B]=f.userId}c[G]=f.appVer;c[J]=n;c["session_id"]=f.id;c[W]=f.activityId;if(f.ip){c[Y]=f.ip}l[P]=c;s.push(l);if(f.end>0){var v={};v[k]=Q;c={};c[Z]=22;c[K]=H(new Date(f.end));if(f.userId){c[B]=f.userId}c[G]=f.appVer;c["session_id"]=f.id;c[J]=n;c[W]=f.activityId;v[P]=c;s.push(v)}}a=e.eventList.length;for(var u=0;u<a;u++){var p=e.eventList[u];var d={};d[k]="custom_event_log";var c={};c["event_tag"]=p.id;c["event_time"]=H(new Date(p.time));c[B]=p.userId;c[J]=n;c[W]=p.activityId;if(p.appVer){c["app_ver"]=p.appVer}if(p.value){if(p.value[i]){c["event_label"]=p.value[i];delete p.value[i]}if(p.value[r]){c["event_value"]=p.value[r];delete p.value[r]}var h=false;for(var g in p.value){h=true;break}if(h){d["ext_properties"]=p.value}}d[P]=c;s.push(d)}a=e.errorList.length;for(var u=0;u<a;u++){var y=e.errorList[u];var d={};d[k]="exception_log";var c={};c["ex_type"]=y.type;c["ex_time"]=H(new Date(y.time));c["ex_msg"]=y.msg;c[W]=y.activityId;if(y.appVer){c["app_ver"]=y.appVer}d[P]=c;s.push(d)}if(s.length===0){return null}else{return JSON.stringify(o)}}var ae=null;var ue=null;function fe(){if(window.XMLHttpRequest){ae=new XMLHttpRequest;if(!("withCredentials"in ae)&&window.XDomainRequest){if(window.location.protocol!=="http:"){d("sdk just support http protocol");return false}ae=new XDomainRequest}}else if(window.ActiveXObject){try{ae=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{ae=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}if(ae==null){g("Can not create XMLHttpRequest object");return false}return true}function le(e,t,n,i){if(fe()){ue=n;if(i===undefined||i===null||i.constructor!==Boolean){i=true}if(window.XDomainRequest&&ae.constructor===XDomainRequest){t=re(t);ae.onerror=ve;ae.ontimeout=pe;ae.onload=ce;ae.open("POST",e)}else{ae.onreadystatechange=de;ae.open("POST",e,i);if(ie()){t=se(t);ae.setRequestHeader("Content-Type","application/gzip;")}else{ae.setRequestHeader("Content-Type","application/json;")}}ae.send(t)}else{n.onFail("Fail to create request")}}function ce(){if(typeof ae.responseText==="string"&&ae.responseText!==""){d("Upload result = "+ae.responseText)}if(ue&&ue.onSuccess&&typeof ue.onSuccess==="function"){ue.onSuccess()}}function ve(){if(ue&&ue.onFail&&typeof ue.onFail==="function"){ue.onFail("Unknown error")}}function pe(){if(ue&&ue.onFail&&typeof ue.onFail==="function"){ue.onFail("Time out")}}function de(){if(ae.readyState==4){if(ae.status==200){if(typeof ae.responseText==="string"&&ae.responseText!==""){d("Upload result = "+ae.responseText)}if(ue&&ue.onSuccess&&typeof ue.onSuccess==="function"){ue.onSuccess()}}else{if(ue&&ue.onFail&&typeof ue.onFail==="function"){ue.onFail(ae.responseText)}}}else{d("Upload processed, status = "+ae.readyState)}}var he="http://cloud-atlas-collection.oth.web.sdp.101.com/";var ge=null,ye=null,Ie=null,we=null;var me=0;var Le=5;function xe(){ge=new n}function be(){if(ye==null){ye=new e}return ye}function Se(){return ge}function _e(t){if(ye){var n=ye;ye=null;if(t===undefined||t===null||t.constructor!==Boolean){t=true}if(!t){var i=n.sessionList.length;if(i>0){ye=new e;ye.sessionList.push(n.sessionList.pop())}}if(Ie){Ie.merge(n)}else{Ie=n}}}function Ve(){we=Ie;Ie=null;return we}function Fe(){we=null}function Te(){if(Ie!==null){if(we!=null){Ie.merge(we)}}else{Ie=we}we=null}function Ae(){me++;if(me>=Le){_e(false);qe();me=0}}var Me=0;var Ne=false;var Oe={onSuccess:function(){d("Upload success");Fe();De()},onFail:function(e){h("Upload failed, reason = "+(e?e:"unknown reason"));Te();De()}};function De(){Ne=false;Me--;if(Me>0){Ee()}}function Ee(e){var t=Ve();if(t!==null&&t.hasValidData()){Ne=true;var n=oe(t);if(n!==null){d("Upload = "+n);le(he+"v0.1/"+q()+"/action/collect",n,Oe,e)}else{Oe.onSuccess()}}}function qe(e){Me++;if(!Ne){Ee(e)}}var Ce=false;var je=15*1e3,Xe=60*60*1e3;var Re=je;function Ue(e,t,n){try{if(Ce){h("Init too many times")}else{M();U();D(e,t);xe();ne(n);Ce=true}}catch(e){g("Failed to init",e);if(u){throw e}}}function ze(){try{if(Ce){var e=z();Pe(e)}else{g("Not allowed to open session before init")}}catch(e){g("Failed to open session",e);if(u){throw e}}}function He(){var e=be();if(e.sessionList&&e.sessionList.length>0){return true}else{return false}}function ke(){try{if(Ce){d("Close the page");var e=be();if(e.sessionList&&e.sessionList.length>0){var t=z();var n=e.sessionList[e.sessionList.length-1];n.end=t;Fe();_e();qe(false)}else{h("No session when page close")}}else{g("Not allowed to close session before init")}}catch(e){g("Failed to close session",e);if(u){throw e}}}function Pe(e){var t=be();var n=Se();Be(e,t,n,true)}function Be(e,n,i,r){var s=E();i.appVer=s;var o=i.userId;var a=C();var u=i.ip;if(!r){if(i.sessionId&&n.sessionList.length>0){var f=null;var l=n.sessionList.length;for(var c=0;c<l;c++){var v=n.sessionList[c];if(v.id===i.sessionId){f=v;break}}if(f!=null){f.end=e}else{g("No current session object found for sessionId "+i.sessionId)}}M()}var p=new t(a,e,0,o,s,u,T);n.sessionList.push(p);_e();qe();i.sessionId=a;n=be();var d=new t(a,e,e,o,s,u,T);n.sessionList.push(d)}function Je(e){try{if(Ce){var t=z();var n=Se();var i=n.userId;if(i===e){h("Same user, no need to login again");return}if(i){Ke()}n.userId=e;var r=be();Be(t,r,n,false)}else{g("Not allowed to sign in before init")}}catch(e){g("Failed to sign in",e);if(u){throw e}}}function Ke(){try{if(Ce){var e=Se();var t=e.userId;if(t){e.userId=null;var n=z();var i=be();Be(n,i,e,false)}else{h("No user is login now, no need to logout, maybe something wrong with app")}}else{g("Not allowed to sign off before init")}}catch(e){g("Failed to sign off",e);if(u){throw e}}}function Ye(e){var t=e.eventId;var n={};if(e.info){for(var o in e.info){n[o]=e.info[o]}}if(e.label){n[i]=e.label}if(e.value){n[r]=e.value}var a=z();var u=Se();var f=u.userId;var l=u.appVer;var c=new s(t,n,a,f,l,T);var v=be();v.eventList.push(c);Ae()}function Ze(e){var t=z();var n=Se();var i=n.appVer;var r=new a(o,e,t,i,T);var s=be();s.errorList.push(r);Ae()}var Ge=new Object;Ge.init=function(e){if(e===undefined||e===null||typeof e!=="object"){g("Invalid params for init, type = "+typeof e+", value = "+e);return}var t=e.appKey;if(t===undefined||t===null||t.constructor!==String){g("Invalid appKey, type = "+typeof t+", value = "+t);return}var n=e.appVer;if(n===undefined||n===null||n.constructor!==String){g("Invalid appVer, type = "+typeof n+", value = "+n);return}if(n.length>255){n=n.substring(0,255)}var i=n.replace(/[^\a-\z\A-\Z0-9\u4E00-\u9FA5\.\_\-]/g,"");if(i!=n){h("版本号仅支持中文，英文字母、数字、中划线（-）、下划线（_）和点号（.），其他符号将会自动被过滤")}n=i;var r=e.isDebugMode;if(r!==undefined&&r!==null&&r.constructor!==Boolean){g("Invalid isDebugMode, type = "+typeof r+", value = "+r);return}var s=e.gzipFun;if(s!==undefined&&s!==null&&s.constructor!==Function){g("Invalid gzipFun, type = "+typeof s+", value = "+s);return}r=r||false;if(r){f(r)}Ue(t,n,s)};Ge.onOpen=function(){ze()};Ge.onClose=function(){ke()};Ge.onProfileSignIn=function(e){if(e===undefined||e===null||e.constructor!==String){g("Invalid params for onProfileSignIn, type = "+typeof e+", value = "+e);return}Je(e)};Ge.onProfileSignOff=function(){Ke()};Ge.onEvent=function(e){if(e===undefined||e===null||typeof e!=="object"){g("Invalid params for onEvent, type = "+typeof e+", value = "+e);return}var t=e.eventId;if(t===undefined||t===null||t.constructor!==String){g("Invalid params for onEvent, eventId type = "+typeof t+", value = "+t);return}var n=e.label;if(n!==undefined&&n!==null&&n.constructor!==String){g("Invalid params for onEvent, label type = "+typeof n+", value = "+n);return}var i=e.info;if(i!==undefined&&i!==null){if(typeof i!=="object"){g("Invalid params for onEvent, info type = "+typeof i+", value = "+i);return}else{for(var r in i){if(!i[r]||i[r].constructor!==String){g("Invalid params for onEvent, type of info."+r+" = "+typeof i[r]+", value = "+i[r]);return}}}}var s=e.value;if(s!==undefined&&s!==null){if(s.constructor!==Number){g("Invalid params for onEvent, value type = "+typeof s+", value = "+s);return}else{if(parseInt(s)!==s){g("Invalid params for onEvent, value is not int : "+s);return}}}if(!He()){ze()}Ye(e)};Ge.reportError=function(e){if(e===undefined||e===null||e.constructor!==String){g("Invalid params for reportError, type = "+typeof e+", value = "+e);return}if(!He()){ze()}Ze(e)};Ge.setLogEnabled=function(e){if(e===undefined||e===null||e.constructor!==Boolean){g("Invalid params for setLogEnabled, type = "+typeof e+", value = "+e);return}p(e)};Ge.setHttps=function(){he="https://cloud-atlas-collection.oth.web.sdp.101.com/"};Ge.testSend=function(){this.setLogEnabled(true);var e={appKey:"101ppt",appVer:"0.0.1",gzipFun:window.pako.gzip};this.init(e);he="http://cloud-atlas-collection.dev.web.nd/";this.onOpen()};return Ge}();