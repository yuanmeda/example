!function(e){"use strict";e="default"in e?e["default"]:e;!function(t,n){function a(e){this.model={multiSelectId:e.multiSelectId||"",tags:e.tags,type:e.type()||o,selectedTab:0,loading:!0,nochapterdata:!1,noknowledgedata:!1,selectedNode:null},this.onSelect=e.onSelect,this.init(e),this.chapterTree=null,this.knowledgeTree=null,e.multiSelectId.subscribe(function(){e.multiSelectId()?i.getData():i.getNoData()})}var i,o="tmaterial",d=n.selfUrl||"",l={getCoursesChapters:function(e){var n=d+"/v1/courses/"+e+"/chapters",a={component:component};return t.ajax({url:n,data:a})},getTmaterialsChapters:function(e){var n=d+"/v1/teaching_materials/"+e+"/chapters",a={component:component};return t.ajax({url:n,data:a})},getCourseKnowledges:function(e){var n=d+"/v1/courses/"+e+"/knowledges",a={component:component};return t.ajax({url:n,data:a})}};a.prototype={init:function(t){i=this,this.model=e.mapping.fromJS(this.model),this.model.multiSelectId()?this.getData():this.getNoData()},getData:function(){var e=this,t=this.model.multiSelectId(),n=this.model.type();this.initChapterzTree(""),this.initKnowledgezTree(""),n==o?this.getTmaterialsChapters(t):function(){e.getCoursesChapters(t),e.getCoursesKnowleges(t)}()},getNoData:function(){this.getNoChapterData(),this.getNoKnowledgeData()},getNoChapterData:function(){this.initChapterzTree(""),this.model.loading(!1).nochapterdata(!0)},getNoKnowledgeData:function(){this.initKnowledgezTree(""),this.model.loading(!1).noknowledgedata(!0)},getChapters:function(e){this.model.loading(!1),e?(this._hideData(e),this.initChapterzTree(e),this.model.nochapterdata(!1)):this.model.nochapterdata(!0)},getKnowledges:function(e){this.model.loading(!1),e&&e.wrong_count?(this._addTypeAndId(e),this._hideData(e),this.initKnowledgezTree(e.items),this.model.noknowledgedata(!1)):this.model.noknowledgedata(!0)},_hideData:function(e){var n=this;e.items&&t.each(e.items,function(e,t){0==t.wrong_count?t.isHidden=!0:n._hideData(t)})},_addTypeAndId:function(e){e.items&&(t.each(e.items,function(e,t){t.type="knowledge_points",t.id=t.lesson_id+"_"+t.knowledge_id}),e.items.unshift({id:e.id,type:e.type,title:e.title,knowledge_id:null,parent_knowledge_id:null,wrong_count:e.wrong_count||0}))},getCoursesChapters:function(e){var t=this;this.model.loading(!0).nochapterdata(!1),l.getCoursesChapters(e).done(function(e){t.getChapters(e)}).fail(function(e){t.getNoChapterData()})},getCoursesKnowleges:function(e){var t=this;l.getCourseKnowledges(e).done(function(e){t.getKnowledges(e)}).fail(function(e){t.getNoKnowledgeData()})},getTmaterialsChapters:function(e){var t=this;this.model.loading(!0).nochapterdata(!1),l.getTmaterialsChapters(e).done(function(e){t.getChapters(e)}).fail(function(e){t.getNoChapterData()})},getTmaterialsKnowleges:function(e){var t=this;l.getTmaterialsChapters(e).done(function(e){t.getChapters(e)}).fail(function(e){t.getNoKnowledgeData()})},mathJaxInit:function(){MathJax.Hub.Typeset()},initChapterzTree:function(n){var a=this,i={view:{showLine:!1,showIcon:!1,nameIsHTML:!0,selectedMulti:!1},data:{key:{name:"title",title:"title",count:"wrong_count",children:"items"},simpleData:{enable:!1,idKey:"id",pIdKey:"parent_id"}},callback:{onClick:a.nodeClick,onExpand:a.mathJaxInit}};t.fn.zTree._z.view.makeDOMNodeNameAfter=function(e,t,n){e.push("<span class='tree-count'>"+n.wrong_count+"题</span></a>")},a.chapterTree=t.fn.zTree.init(t("#chapterTree"),i,n);var o=a.chapterTree.getNodes();if(o.length>0){o[0].title="全部章节",a.chapterTree.updateNode(o[0]);for(var d=0;d<o.length;d++)a.chapterTree.expandNode(o[d],!0,!1,!1,function(){a.mathJaxInit});var l=e.mapping.toJS(a.model.tags),r=o[0];l&&l.length>0&&t.each(l,function(e,t){if(("chapter"==t.type||"cloud_chapter"==t.type||"cloud_course"==t.type)&&t.value){var n=a.chapterTree.getNodeByParam("id",t.value);return n&&(r=n),!1}}),a.chapterTree.selectNode(r),a._decorateNode(r)}},initKnowledgezTree:function(n){var a=this,i={view:{showLine:!1,showIcon:!1,nameIsHTML:!0,selectedMulti:!1},data:{key:{name:"title",title:"title",count:"wrong_count"},simpleData:{enable:!0,idKey:"knowledge_id",pIdKey:"parent_knowledge_id",rootKey:null}},callback:{onClick:a.nodeClick,onExpand:a.mathJaxInit}};t.fn.zTree._z.view.makeDOMNodeNameAfter=function(e,t,n){e.push("<span class='tree-count'>"+n.wrong_count+"题</span></a>")},a.knowledgeTree=t.fn.zTree.init(t("#knowledgeTree"),i,n);var o=a.knowledgeTree.getNodes();if(o.length>0){o[0].title="全部知识点",a.knowledgeTree.updateNode(o[0]);for(var d=0;d<o.length;d++)a.knowledgeTree.expandNode(o[d],!0,!1,!1,function(){a.mathJaxInit});var l=e.mapping.toJS(a.model.tags),r=null;l&&l.length>0&&t.each(l,function(e,t){if(("knowledge_points"==t.type||"ndr_course"==t.type)&&t.value){var n=a.knowledgeTree.getNodeByParam("knowledge_id",t.value);return n&&(r=n),!1}}),r&&(a.chapterTree.cancelSelectedNode(),a.knowledgeTree.selectNode(r),a._decorateNode(r),a.model.selectedTab(1))}},_decorateNode:function(e){var n=t("#"+e.tId),a=t(".tree-con").width()||310;t(".current-bg-dom").remove(),n.prepend('<div class="current-bg-dom"></div>');var i=n.attr("class"),o=Number(i.replace("level",""));t(".current-bg-dom").css({width:a,marginLeft:21*-o-10+"px",marginBottom:"-47px"})},nodeClick:function(e,t,n){1==i.model.selectedTab()?i.chapterTree&&i.chapterTree.cancelSelectedNode():i.knowledgeTree&&i.knowledgeTree.cancelSelectedNode(),i._decorateNode(n),i.onSelect(n)},onTabChange:function(e){this.model.selectedTab(e)}},e.components.register("x-wrongquestion-tree",{viewModel:a,template:'<div class="select-tab" data-bind="css:{\'tmaterial_tab\': model.type()==\'tmaterial\'}">\r\n  <a class="" data-bind="css:{\'active\':model.selectedTab()== 0},event:{click:onTabChange.bind($data,0)}" href="javascript:;" title="按章节">按章节</a>\r\n  <a class="last" data-bind="visible:model.type()!=\'tmaterial\',css:{\'active\':model.selectedTab()== 1},event:{click: onTabChange.bind($data,1)}" href="javascript:;" title="按知识点">按知识点</a>\r\n</div>\r\n<div class="tree-con">\r\n    <div style="height: 50px;line-height: 50px; text-align: center; color: #999;" data-bind="visible: model.loading">加载中...</div>\r\n    <div data-bind="visible: model.selectedTab() == 0">\r\n        <div style="height: 50px;line-height: 50px; text-align: center; color: #999;" data-bind="visible: model.nochapterdata">暂无数据</div>\r\n        <ul id="chapterTree" class="ztree"></ul>\r\n    </div>\r\n    <div data-bind="visible: model.selectedTab() == 1">\r\n        <div style="height: 50px;line-height: 50px; text-align: center; color: #999;" data-bind="visible: model.noknowledgedata">暂无数据</div>\r\n        <ul id="knowledgeTree" class="ztree" ></ul>\r\n    </div>\r\n</div>'})}(jQuery,window)}(ko);
