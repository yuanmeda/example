!function(e){"use strict";function t(e){this.callBack=e.callBack,this.questionType=e.questionType,this.model={flag:e.flag,multiSelectId:e.multiSelectId,needMultiSelectId:e.needMultiSelectId,tags:e.tags,chosenSubject:e.subject,chosenCourse:e.courseId,showCourseTags:e.showCourseTags,showQuestionTypes:e.showQuestionTypes,filter:{component:e.flag,tag_types:"homework"==e.flag?"subject&tag_types=question_type&tag_types=wrong_reason&tag_types=teaching_material":"course&tag_types=question_type&tag_types=wrong_reason"},mastery:["全部","未掌握","重点错题","已掌握"],subject_tags:[],subject_tag_index:0,course_tags:[],course_tag_index:0,question_types:[],question_type_index:0,wrong_reason_tags:[],wrong_reason_index:0,teaching_material_tags:[],teaching_material_tag_index:0,mastered_index:1,questionTags:{is_mark_key:{type:"",value:!1},is_mastered:{type:"",value:!1},teaching_material:{type:"",value:""},course:{type:"",value:""},question_type:{type:"",value:""},wrong_reason:{type:"",value:""}}},this.init(e)}e="default"in e?e["default"]:e;var s={getErrorStatistics:function(e){return $.ajax({url:wrongQuestionGatewayUrl+"/v1/wrong_questions/stat?component="+e.component+"&tag_types="+e.tag_types,dataType:"json",type:"POST"})}};t.prototype={init:function(t){var a=this;this.model=e.mapping.fromJS(this.model);var n=e.mapping.toJS(this.model.filter);s.getErrorStatistics(n).done(function(e){if(e){a.model.subject_tags(e.subject_tags);var s=[];if(t.subject){for(var n=0;n<e.subject_tags.length;n++){var i=e.subject_tags[n];if(i.tag_name==t.subject||i.tag_value==t.subject){a.model.subject_tag_index(n),s=i.teaching_material_tags?i.teaching_material_tags:[];break}}if(0==s.length)return void a._showEmpty()}else s=e.subject_tags.length&&e.subject_tags[0].teaching_material_tags?e.subject_tags[0].teaching_material_tags:[];if(t.courseId){for(var n=0;n<e.course_tags.length;n++)if(e.course_tags[n].tag_value==t.courseId){a.model.course_tag_index(n);break}if(n==e.course_tags.length)return void a._showEmpty()}var o=e.course_tags;a.model.questionTags.course.type(o.length?o[a.model.course_tag_index()].tag_type:""),a.model.questionTags.course.value(o.length?o[a.model.course_tag_index()].tag_value:""),a.model.teaching_material_tags(s),a.model.course_tags(e.course_tags),$.each(e.question_types,function(e,t){t.tag_name=a.questionType[t.tag_value]}),a.model.question_types(e.question_types),a.model.wrong_reason_tags(e.wrong_reason_tags),a.model.questionTags.is_mastered.type("is_mastered"),a.model.questionTags.is_mastered.value(!1),a.model.questionTags.teaching_material.type(s.length?s[0].tag_type:""),a.model.questionTags.teaching_material.value(s.length?s[0].tag_value:""),a._mergeTags(t.subject||t.courseId,e),!a.model.multiSelectId()&&t.needMultiSelectId()&&(o&&o.length&&a.model.multiSelectId(o[a.model.course_tag_index()].tag_value),s.length&&a.model.multiSelectId(s[0].tag_value)),a.callBack(a.model.questionTags)}}),setTimeout(function(){var e=$(".select-list-cell"),s=$(e[0].children[0]).outerHeight(!0)||37;"homework"==t.flag?$.each(e,function(e,t){var a=$(t).find("span:last");a&&a.position().top>=s&&($(t).parent().css("height",s+"px"),$(t).next().css("display","block"))}):$.each(e,function(e,t){var a=$(t).find("span:last");"true"==showCourseTags&&0==e&&a&&a.position().top==s?$(t).parent().parent().css("height",2*s+"px"):"true"==showCourseTags&&0==e&&a&&a.position().top>s?($(t).parent().parent().css("height",2*s+"px"),$(t).parent().css("height",2*s+"px"),$(t).parent().css("min-height",2*s+"px"),$(t).parent().parent().css("min-height",2*s+"px"),$(t).next().css("display","block")):0!=e&&a&&a.position().top>=s&&($(t).parent().css("height",s+"px"),$(t).next().css("display","block"))})},500)},_showTip:function(e){$("#js_tip").html(e),$("#js_tip").show(),setTimeout(function(){$("#js_tip").hide(),$("#js_tip").html("")},1e3)},_showEmpty:function(){$(".main.main-homework").hide(),$(".error-empty").show()},_mergeTags:function(t,s){var a=this,n=e.mapping.toJS(a.model.tags);!t&&n&&n.length>0&&$.each(n,function(e,t){a.model.questionTags[t.type]&&(a.model.questionTags[t.type].type(t.type),a.model.questionTags[t.type].value(t.value),a._locateIndex(t,s))})},_locateIndex:function(e,t){var s=this;switch(e.type){case"is_mastered":e.value?s.model.mastered_index(3):null!=e.value?s.model.mastered_index(1):2!=s.model.mastered_index()&&s.model.mastered_index(0);break;case"is_mark_key":e.value&&s.model.mastered_index(2);break;case"teaching_material":$.each(t.subject_tags,function(t,a){var n=s._getIndex(e.value,a.teaching_material_tags);if(-1!=n)return s.model.teaching_material_tag_index(n),s.model.subject_tag_index(t),s.model.teaching_material_tags(a.teaching_material_tags),!1});break;case"course":var a=s._getIndex(e.value,t.course_tags);-1!=a&&s.model.course_tag_index(a);break;case"question_type":var a=s._getIndex(e.value,t.question_types);-1!=a&&s.model.question_type_index(a+1);break;case"wrong_reason":var a=s._getIndex(e.value,t.wrong_reason_tags);-1!=a&&s.model.wrong_reason_index(a+1)}},_getIndex:function(e,t){var s=-1;return $.each(t,function(t,a){if(a.tag_value==e)return s=t,!1}),s},switchSubject:function(e,t){$(e).addClass("active").siblings().removeClass("active"),this.model.teaching_material_tag_index(0),this.model.teaching_material_tags(t&&t.teaching_material_tags?t.teaching_material_tags:[]);var s=t&&t.teaching_material_tags?t.teaching_material_tags:[],a=s.length;this.model.multiSelectId(a?s[0].tag_value:""),this.model.questionTags.teaching_material.type(a?s[0].tag_type:""),this.model.questionTags.teaching_material.value(a?s[0].tag_value:""),this.callBack(this.model.questionTags),window.parent.postMessage(JSON.stringify({type:"changeSubject",name:"changeSubject",subject:t.tag_name}),"*")},switchMaterial:function(e,t){$(e).addClass("active").siblings().removeClass("active"),this.model.multiSelectId(t.tag_value),this.model.questionTags.teaching_material.type(t.tag_type),this.model.questionTags.teaching_material.value(t.tag_value),this.callBack(this.model.questionTags)},switchQuestionType:function(e,t){$(e).addClass("active").siblings().removeClass("active"),this.model.questionTags.question_type.type(t.tag_type),this.model.questionTags.question_type.value(t.tag_value),this.callBack(this.model.questionTags)},switchWrongReason:function(e,t){$(e).addClass("active").siblings().removeClass("active"),this.model.questionTags.wrong_reason.type(t.tag_type),this.model.questionTags.wrong_reason.value(t.tag_value),this.callBack(this.model.questionTags)},switchMaster:function(e,t){switch($(e).addClass("active").siblings().removeClass("active"),t){case 0:this.model.questionTags.is_mastered.type("is_mastered"),this.model.questionTags.is_mark_key.type("is_mark_key"),this.model.questionTags.is_mastered.value(null),this.model.questionTags.is_mark_key.value(null);break;case 1:this.model.questionTags.is_mastered.type("is_mastered"),this.model.questionTags.is_mark_key.type("is_mark_key"),this.model.questionTags.is_mastered.value(!1),this.model.questionTags.is_mark_key.value(null);break;case 2:this.model.questionTags.is_mastered.type("is_mastered"),this.model.questionTags.is_mark_key.type("is_mark_key"),this.model.questionTags.is_mark_key.value(!0),this.model.questionTags.is_mastered.value(null);break;case 3:this.model.questionTags.is_mastered.type("is_mastered"),this.model.questionTags.is_mark_key.type("is_mark_key"),this.model.questionTags.is_mastered.value(!0),this.model.questionTags.is_mark_key.value(null)}this.callBack(this.model.questionTags)},switchCourse:function(e,t){$(e).addClass("active").siblings().removeClass("active"),this.model.multiSelectId(t.tag_value),this.model.questionTags.course.type(t.tag_type),this.model.questionTags.course.value(t.tag_value),this.callBack(this.model.questionTags)},switchAll:function(e,t){switch($(e).addClass("active").siblings().removeClass("active"),t){case 0:this.model.questionTags.question_type.type("");break;case 1:this.model.questionTags.wrong_reason.type("")}this.callBack(this.model.questionTags)},showMore:function(e){$(e).hasClass("active")?($(e).parent().parent().css("height","25px"),$(e).parent().css("height","25px"),$(e).removeClass("active")):($(e).parent().parent().css("height","auto"),$(e).parent().css("height","auto"),$(e).addClass("active"))}},e.components.register("x-wrongquestion-multiselect",{viewModel:t,template:'\x3c!-- ko if: model.flag() == \'homework\' --\x3e\r\n<div id="multiSelectBox" class="select-bar">\r\n    <dl>\r\n        <dt>学科</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                \x3c!-- ko foreach: model.subject_tags --\x3e\r\n                <span data-bind="text: tag_name, css: {\'active\': $index() == $parent.model.subject_tag_index()}, click: $parent.switchSubject.bind($parent, $element)"></span>\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n    <dl>\r\n        <dt>教材</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                \x3c!-- ko foreach: model.teaching_material_tags --\x3e\r\n                <span data-bind="text: tag_name, css: {\'active\': $index() == $parent.model.teaching_material_tag_index()}, click: $parent.switchMaterial.bind($parent, $element)"></span>\x3c!--默认第一个为选择--\x3e\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n    <dl>\r\n        <dt>题型</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                <span data-bind="css: {\'active\': $component.model.question_type_index() == 0},click: $component.switchAll.bind($component, $element, 0)">全部</span>\r\n                \x3c!-- ko foreach: model.question_types --\x3e\r\n                <span data-bind="css: {\'active\': $index() == $parent.model.question_type_index() - 1},text: tag_name, click: $parent.switchQuestionType.bind($parent, $element)"></span>\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n    \x3c!--掌握度默认就这样--\x3e\r\n    <dl>\r\n        <dt>掌握度</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                \x3c!-- ko foreach: model.mastery --\x3e\r\n                <span data-bind="text: $data, css: {\'active\': $index() == $parent.model.mastered_index()}, click: $parent.switchMaster.bind($parent, $element, $index())"></span>\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n    <dl class="last">\r\n        <dt>错因</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                <span data-bind="css: {\'active\': $component.model.wrong_reason_index() == 0},click: $component.switchAll.bind($component, $element, 1)">全部</span>\r\n                \x3c!-- ko foreach: model.wrong_reason_tags --\x3e\r\n                <span data-bind="css:{\'active\': $index() == $parent.model.wrong_reason_index() - 1},text: tag_name, click: $parent.switchWrongReason.bind($parent, $element)"></span>\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n</div>\r\n\x3c!-- /ko --\x3e\r\n\r\n\r\n\x3c!--课程开始--\x3e\r\n\x3c!-- ko if: model.flag() == \'course\' --\x3e\r\n<div id="multiSelectBox" class="select-bar">\r\n    \x3c!-- ko if: model.showCourseTags()--\x3e\r\n    <dl>\r\n        <dt>课程</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                \x3c!-- ko foreach: model.course_tags --\x3e\r\n                <span data-bind="text: tag_name, css: {\'active\': $index() == $parent.model.course_tag_index()}, click: $parent.switchCourse.bind($parent, $element)"></span>\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n    \x3c!-- /ko --\x3e\r\n    \x3c!-- ko if: model.showQuestionTypes()--\x3e\r\n    <dl>\r\n        <dt>题型</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                <span data-bind="css: {\'active\': $component.model.question_type_index() == 0},click: $component.switchAll.bind($component, $element, 0)">全部</span>\r\n                \x3c!-- ko foreach: model.question_types --\x3e\r\n                <span data-bind="css: {\'active\': $index() == $parent.model.question_type_index() - 1},text: tag_name, click: $parent.switchQuestionType.bind($parent, $element)"></span>\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n    \x3c!-- /ko --\x3e\r\n    \x3c!--掌握度默认就这样--\x3e\r\n    <dl>\r\n        <dt>掌握度</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                \x3c!-- ko foreach: model.mastery --\x3e\r\n                <span data-bind="text: $data, css: {\'active\': $index() == $parent.model.mastered_index()}, click: $parent.switchMaster.bind($parent, $element, $index())"></span>\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n    <dl class="last">\r\n        <dt>错因</dt>\r\n        <dd>\r\n            <div class="select-list-cell">\r\n                <span data-bind="css: {\'active\': $component.model.wrong_reason_index() == 0},click: $component.switchAll.bind($component, $element, 1)">全部</span>\r\n                \x3c!-- ko foreach: model.wrong_reason_tags --\x3e\r\n                <span data-bind="css:{\'active\': $index() == $parent.model.wrong_reason_index() - 1},text: tag_name, click: $parent.switchWrongReason.bind($parent, $element)"></span>\r\n                \x3c!-- /ko --\x3e\r\n            </div>\r\n            <span class="btn-more" data-bind="click: showMore.bind($root, $element)">更多</span>\r\n        </dd>\r\n    </dl>\r\n</div>\r\n\x3c!-- /ko --\x3e'})}(ko);
