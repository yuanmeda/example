!function(e,t){var n="undefined"!=typeof AndroidInterface;if(n){var i=e.QtiPlayer.getLogger(),a=e.QtiPlayer;a.HandwriteInteraction||(a.HandwriteInteraction={clipBoardId:{},instances:{},createListener:[],deleteListener:[],removeItem:function(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(isNaN(t)||(i=n),i==t){for(var a=n;a<e.length;a++)e[a]=e[a+1];e.length=e.length-1}}},clearCache:function(){for(var e in a.HandwriteInteraction.instances){var t=a.HandwriteInteraction.instances[e];null==t||t.isDomExist()||(t._fullScreenCallBack(!1),delete a.HandwriteInteraction.instances[e])}},clearInstance:function(e){for(var t in a.HandwriteInteraction.instances)a.HandwriteInteraction.instances[t]==e&&(e._fullScreenCallBack(!1),delete a.HandwriteInteraction.instances[t])},updateAnswer:function(e){for(var t in a.HandwriteInteraction.instances){var n=a.HandwriteInteraction.instances[t];null==n||n.isDomExist()?n.updateAnswer(e):(n._fullScreenCallBack(!1),delete a.HandwriteInteraction.instances[t])}},registerListener:function(e,t){t.create?(this.removeItem(this.createListener,e),this.createListener.push(e)):t.remove&&(this.removeItem(this.deleteListener,e),this.deleteListener.push(e))},removeListener:function(e){this.removeItem(this.createListener,e),this.removeItem(this.deleteListener,e)},excCreateListener:function(e,t){for(var n=0;n<this.createListener.length;n++){var i=this.createListener[n];i&&i(e,t)}},excRemoveListener:function(e,t){for(var n=0;n<this.deleteListener.length;n++){var i=this.deleteListener[n];i&&i(e,t)}}});var r=function(e,t){"undefined"!=typeof Bridge&&Bridge.registerListener&&Bridge.registerListener(e,t)};r("HandwriteInteraction.Writing",function(e){for(var t in a.HandwriteInteraction.instances){var n=a.HandwriteInteraction.instances[t];null==n||n.isDomExist()?n.writing(e&&e.id):(n._fullScreenCallBack(!1),delete a.HandwriteInteraction.instances[t])}}),r("HandwriteInteraction.updateAnswer",function(e){for(var t in a.HandwriteInteraction.instances){var n=a.HandwriteInteraction.instances[t];null==n||n.isDomExist()?n.updateAnswerComplete(e&&e.id,e&&e.base64):(n._fullScreenCallBack(!1),delete a.HandwriteInteraction.instances[t])}});var s={_name:"drawingInteraction_handwrite",getName:function(){return this._name},create:function(e){a.HandwriteInteraction.clearCache();var t=null;e.init=function(){t=new c(e),a.HandwriteInteraction.instances[t.interactionId]=t},e.hasNum=function(){return!1},e.createTitleHtml=function(){return t.createTitleHtml()},e.createAnswerHtml=function(e){return t.setOption(e),t.createHtml()},e.render=function(e,n){t.setOption(n)},e.eventHandle=function(e,n){t.eventHandle(e)},e.destroy=function(){QtiPlayer.HandwriteInteraction.clearInstance(t),t=null}}};a.registerModelHandler(s);var c=e.QtiPlayer.Class(e.QtiPlayer.BaseInteraction,function(){var e=function(e,t){return!("undefined"==typeof Bridge||!Bridge||!Bridge.callNative)&&Bridge.callNative("com.nd.pad.icr.ui.IcrJsBridge",e,t)},n=function(t){var n=e("removeClipboard",{id:t});return n&&n.success&&delete a.HandwriteInteraction.clipBoardId[t],a.HandwriteInteraction.excRemoveListener(t,n),n},r=function(t,n,i,r,s,c){var o=e("addClipboard",{id:t,left:n,top:i,right:r,bottom:s,bgUrl:c});return o&&o.success&&(a.HandwriteInteraction.clipBoardId[t]=t),a.HandwriteInteraction.excCreateListener(t,o),o},s=function(t){return e("getClipboardContent",{id:t})},c={Create:function(e,t,n){this.base(e,t,n),this.canvasWidth=0,this.canvasHeight=0,this._fullScreen=!1,this.canvasNativeHeight=0,this.canvasId=this.interactionId+"-canvas",this.nativeCanvasId=this.interactionId+"native",this.contentOffset={},this.answerCount=0,this._fullScreenChangeHandler=this.proxy(this._fullScreenChangeHandler),this._fullScreenCallBack(!0)},proxy:function(e){var t=this;return function(){return e.apply(t,arguments)}},createTitleHtml:function(){return'<div class="qp-model-header">'+this.modalModel.prompt+"</div>"},createHtml:function(){var e=this;e.refPath="",e.setResultXml="";var t=function(){var t="",n=e.modalModel.object.data,i="",a="";return n.length>0?i="background-image: url('"+n+"');":a="qp-hw-cavs-nobg-hd-pad",t+='      <div class="qp-hw-drawing-content" style="visibility: hidden;" >                                                                                                                       ',t+='      <div style="position: relative" class="qp-hw-drawing-box" >                                                                                                                       ',t+='        <div  class="qp-hw-writing_edit" style="display: none">                                                                                                                          ',t+='          <a href="javascript:void(0)" class="qp-hw-writing_botton qp-hw-classlink" style="display:none;" id="btn_back">                                                                  ',t+='              <ins class="qp-hw-icon_back"></ins>                                                                                                                ',t+="          </a>                                                                                                                                                ",t+='          <a href="javascript:void(0)" class="qp-hw-writing_botton qp-hw-classlink" id="write">                                                                     ',t+='              <ins class="qp-hw-icon_writing"></ins>                                                                                                             ',t+="          </a>                                                                                                                                                ",t+='              <a href="javascript:void(0)" class="qp-hw-writing_botton qp-hw-botton_clear" id="clear">                                                              ',t+='                  <ins class="qp-hw-icon_clear"></ins>                                                                                                           ',t+="              </a>                                                                                                                                            ",t+='              <a href="javascript:void(0)"  class="qp-hw-writing_botton qp-hw-botton_allclear qp-hw-classlink" id="clearall">                                          ',t+='                  <ins class="qp-hw-icon_allclear"></ins>                                                                                                        ',t+="              </a>                                                                                                                                            ",t+="        </div>                                                                                                   ",t+='          <canvas class="'+a+' qp-hw-cavs" id="'+e.canvasId+'" style="'+i+'">               ',t+="              Fallback content, in case the browser does not support Canvas.                                                                                  ",t+="          </canvas>                                                                                                                                           ",t+="      </div>                                                                                                                                                  ",t+="      </div>                                                                                                                                                  "},n=function(){return t()};return n()},_fullScreenCallBack:function(e){e=e?"on":"off",t(document)[e]("webkitfullscreenchange",this._fullScreenChangeHandler)},_fullScreenChangeHandler:function(){var e=this;e._fullScreenTrigger=!0,e._fullScreen=!e._fullScreen,clearTimeout(e._fullscreenTimeoutid),e._fullscreenTimeoutid=setTimeout(function(){e._fullScreenTrigger=!1},1e3)},eventHandle:function(e){var a=this;e.attr("data-key",a.interactionId);var s=function(){a.canvasWidth=a.modalModel.object.width,a.canvasHeight=a.modalModel.object.height,a.canvasNativeHeight=a.modalModel.object.height;var t=e.find(".qp-hw-drawing-content canvas");t.css({width:a.canvasWidth,height:a.canvasHeight});try{t&&t.length>0&&t[0]&&(t[0].width=a.canvasWidth,t[0].height=a.canvasHeight)}catch(n){i.debug("手写题渲染异常"),i.debug(t)}e.find(".qp-hw-drawing-box").css({width:a.canvasWidth+3})},c=function(e,t){var n=new Image;n.crossOrigin="anonymous",n.src=e,n.complete?t(n,!0):n.onload=function(){t(n,!0),n.onload=null},n.onerror=function(){t(n,!1),n.onerror=null}},o=function(n){var a=e.find("img");if(a.length<=0)return void n();var r=0;t.each(a,function(e){c(t(a[e]).attr("src"),function(e,t){r++,i.debug("loadSize:"+r),r==a.length&&n()})})},l=function(){s(),o(function(){if(0!=e.find(".qp-hw-drawing-content").length){var t=e.find(".qp-hw-drawing-content").offset();a.contentOffset=t;var s=r(a.nativeCanvasId,t.left,t.top,t.left+a.canvasWidth,t.top+a.canvasNativeHeight,a.modalModel.object.data);s&&s.success?(e.find(".qp-hw-drawing-content").css("visibility","hidden"),e.resize(function(){if(a._fullScreenTrigger||a._fullScreen||document.webkitIsFullScreen)return void i.debug("-------------fullscreent:");i.debug("drawing-resize:"+document.webkitIsFullScreen);var t=e.find(".qp-hw-drawing-content");if(t&&t.length>0){var s=t.offset();if(Math.abs(s.left-a.contentOffset.left)>10||Math.abs(s.top-a.contentOffset.top)>10){i.debug("drawing-resize-do"),a.contentOffset=s;var c=n(a.nativeCanvasId);c&&c.success&&(a.nativeCanvasId+="1",r(a.nativeCanvasId,s.left,s.top,s.left+a.canvasWidth,s.top+a.canvasNativeHeight,a.modalModel.object.data))}}})):e.find(".qp-hw-drawing-content").css("visibility","visible")}})},d=function(t){if(t&&void 0!=t[0]&&null!=t[0]){var n=JSON.parse(t[0].split("|$*-*$|")[0]),i=t[0].split("|$*-*$|")[1],r=a.modalModel.object.data,s="width:"+n.width+"px;height:"+n.height+"px;border: 1px solid rgb(136, 136, 136);"+(r.length>0?"background-image: url('"+r+"');":""),c='<img style="'+s+'" src="'+i+'">';e.find(".qp-hw-drawing-box").attr("style",""),e.find(".qp-hw-drawing-box").html(c),e.find(".qp-hw-drawing-content").css("visibility","visible")}},h=function(){l(),a.option.showAnswer&&d(a.getAnswer())};h()},getCurrentAnswer:function(){var e=this,t="",n=s(e.nativeCanvasId),i={width:e.canvasWidth,height:e.canvasNativeHeight};n&&n.success&&n.content&&n.content.length>0&&("data:"!=n.content.substr(0,5)&&(n.content="data:image/png;base64,"+n.content),t=n.content);var a=[];return a.push(JSON.stringify(i)+"|$*-*$|"+t),a},updateAnswer:function(e){var t=this;t.setAnswer(t.getCurrentAnswer()),this.updateAnswerCallback=e},writing:function(e){var t=this;t.nativeCanvasId==e&&(t.answerCount++,t.setAnswer([t.answerCount]))},updateAnswerComplete:function(e,t){var n=this;if(n.nativeCanvasId==e){var i={width:n.canvasWidth,height:n.canvasNativeHeight};t&&t.length>0&&"data:"!=t.substr(0,5)&&(t="data:image/png;base64,"+t);var a=[];a.push(JSON.stringify(i)+"|$*-*$|"+t),n.setAnswer(a),n.updateAnswerCallback&&n.updateAnswerCallback()}}};return c}())}}(window,jQuery);