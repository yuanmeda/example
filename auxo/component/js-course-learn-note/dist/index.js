!function(e){"use strict";e=e&&"default"in e?e["default"]:e;var t=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e};function n(n){this.maxlength=400,this.model=t({biz_param:n.data.biz_param,noteContent:e.observable(""),isOpen:e.observable(!0),videoCurrentTime:n.data.videoCurrentTime,docInfo:n.data.docInfo,refreshNotes:n.data.refreshNotes,editNoteInfo:n.data.editNoteInfo,excerpt_note_id:n.data.excerpt_note_id,report_count:e.observable(0),note_id:n.data.note_id},"report_count",e.observable(0)),this.wordCount=e.computed(function(){return this.model.noteContent()?this.model.noteContent().length:0},this),this.model.noteContent.subscribe(function(e){e?($(".n-ui-btn-main").show(),$(".n-ui-btn-disable").hide()):($(".n-ui-btn-main").hide(),$(".n-ui-btn-disable").show());var t=this.maxlength;this.model.noteContent(e&&e.length>t?e.substr(0,t):e)},this),this.model.editNoteInfo.subscribe(function(e){var t="string"==typeof e.biz_data?JSON.parse(e.biz_data):e.biz_data;e.biz_data=t,this.model.note_id(e.id),this.model.noteContent(e.content),this.model.videoCurrentTime(e.biz_data&&e.biz_data.location&&e.biz_data.location.location?e.biz_data.location.location:""),this.model.docInfo(e.biz_data&&e.biz_data.location&&e.biz_data.location.location?e.biz_data.location.location:""),this.model.biz_param.resource_type(e.biz_data&&e.biz_data.resource_type?e.biz_data.resource_type:""),this.model.isOpen(e.is_open),this.model.excerpt_note_id(e.excerpt_note_id),this.model.report_count(e.report_count),this.model.biz_param.resource_id(e.biz_data&&e.biz_data.resource_id?e.biz_data.resource_id:""),this.model.report_count(e.report_count?e.report_count:0),$(".add-note-input").removeClass("hide")},this)}var o=function(e,t){return $.ajax({url:e+"/v1/notes",data:JSON.stringify(t),dataType:"json",type:"POST"})},a=function(e,t,n){return $.ajax({url:e+"/v1/notes/"+n,data:JSON.stringify(t),dataType:"json",type:"PUT"})};n.prototype={cancel:function(){$(".add-note-input").addClass("hide"),this.model.noteContent(""),this.model.isOpen(!0)},saveNote:function(){var e,t,n,i,r=this;if(this.model.noteContent()){switch(this.model.biz_param.resource_type()){case"0":case"101":e=this.formatVideoTime(this.model.videoCurrentTime()),t="video";break;case"1":case"102":e=+this.model.docInfo().split("/")[0],t="document";break;case"2":case"103":e=null,t="question";break;case"3":case"104":e=null,t="url";break;case"4":case"105":e=null,t="vr";break;case"5":e=null,t="live";break;case"6":e=null,t="panorama"}var s=JSON.stringify({course_id:this.model.biz_param.course_id(),resource_id:this.model.biz_param.resource_id(),resource_type:+this.model.biz_param.resource_type(),location:e});switch(contextId.split(":")[0]){case"auxo-specialty":case"auxo-train":n=contextId+".business_course:"+this.model.biz_param.course_id(),i=contextId.split(":")[0];break;default:n="business_course:"+this.model.biz_param.course_id(),i="business_course"}var d={content:this.model.noteContent(),target_id:t+":"+this.model.biz_param.resource_id(),target_name:resourceTitle,is_open:this.model.isOpen(),excerpt_note_id:"",biz_url:courseUrl+"/v1/business_courses/biz_data",biz_param:s,context_id:n,custom_type:i,biz_view:"course_biz_view"};this.model.note_id()?a(noteServiceUrl,d,this.model.note_id()).done(function(e){r.model.note_id(""),r.model.noteContent(""),r.model.refreshNotes(!0),r.model.isOpen(!0),$(".add-note-input").addClass("hide")}):o(noteServiceUrl,d).done(function(e){r.model.noteContent(""),r.model.refreshNotes(!0),r.model.isOpen(!0),$(".add-note-input").addClass("hide")})}},formatVideoTime:function(e){var t=e.split(":");return 60*Number(t[0])+Number(t[1])}},e.components.register("x-course-learn-note",{viewModel:n,template:'<div id="x-course-learn-note" style="position: absolute;bottom: 0;left:0;background-color: #EDEDEF;width:360px;">\r\n    <div class="add-note-input hide">\r\n        <div class="note-icon-txt">\r\n            \x3c!-- ko if: model.biz_param.resource_type() == \'0\' || model.biz_param.resource_type() == \'101\' --\x3e\r\n            <a class="note-icon iconfont-learn n-icon-video"></a>\r\n            <span class="note-txt" data-bind="text: model.videoCurrentTime"></span>\r\n            \x3c!-- /ko --\x3e\r\n            \x3c!-- ko if: model.biz_param.resource_type() == \'1\' || model.biz_param.resource_type() == \'102\' --\x3e\r\n            <a class="note-icon iconfont-learn n-icon-chapter"></a>\r\n            <span class="note-txt"><span data-bind="text: model.docInfo"></span></span>\r\n            \x3c!-- /ko --\x3e\r\n        </div>\r\n        <div class="add-note-textarea">\r\n            <form action="">\r\n                <textarea placeholder="在此写下您的笔记..." name="writeDown" id="content" style="padding: 0;resize: none;" \r\n                    data-bind="textInput: model.noteContent, translate:{ key: \'note.placeholder\',target:[\'placeholder\']}"></textarea>\r\n            </form>\r\n            <div style="margin-left: 290px;"><span data-bind="text: wordCount">0</span>/400</div>\r\n        </div>\r\n        <div class="add-note-btns" style="margin-bottom: 10px;">\r\n            \x3c!-- ko if: !model.excerpt_note_id()  && model.report_count() < 3 --\x3e\r\n            <label for="tht" style="position: absolute;left: 0;top: 3px;">\r\n                <input id="tht" type="checkbox" style="margin-bottom: 2px;" data-bind="checked: model.isOpen">\r\n                \x3c!-- ko translate: {key: \'note.isOpen\'} --\x3e\r\n                公开笔记\r\n                \x3c!-- /ko --\x3e\r\n            </label>\r\n            \x3c!-- /ko --\x3e\r\n            \x3c!-- ko if: model.excerpt_note_id() && model.report_count() < 3 --\x3e\r\n            <div class="note-icon-txt">\r\n                <a class="note-icon  iconfont-learn n-icon-star"></a>\r\n                <span class="note-txt note-txt-light-gray" data-bind="translate:{key:\'note.fromExcerpt\'}">来自摘录</span>\r\n            </div>\r\n            \x3c!-- /ko --\x3e\r\n            \x3c!-- ko if: model.report_count() >= 3 --\x3e\r\n            <div class="note-icon-txt">\r\n                <span class="note-txt note-txt-light-gray" data-bind="translate:{key:\'note.reported\'}">被举报</span>\r\n            </div>\r\n            \x3c!-- /ko --\x3e\r\n            <a href="#" class="n-ui-btn n-ui-btn-gray" data-bind="click: cancel, translate: {key: \'note.cancel\'}">取消</a>\r\n            <a href="#" class="n-ui-btn n-ui-btn-main" data-bind="click: saveNote, translate:{key:\'note.save\'}" style="display: none;">保存</a>\r\n            <a href="#" class="n-ui-btn n-ui-btn-disable" data-bind="translate:{key:\'note.save\'}">保存</a>\r\n        </div>\r\n    </div>\r\n</div>'})}(ko);
