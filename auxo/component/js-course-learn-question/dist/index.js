!function(e){"use strict";function t(t){var n=this;this.model={question:null,filter:{page_no:0,page_size:5},answers:{items:[],total:0},state:{showAnswerArea:!1,showMoreContent:!1},content:"",highlight:t.highlight||""},this.model=e.mapping.fromJS(this.model);var i=$.extend(!0,{},t.question);i.answer_count=e.observable(i.answer_count),i.accepted_answer_id=e.observable(i.accepted_answer_id);var s=e.unwrap(this.model.highlight);if(s){var o=i.content,a=i.title;i.content=o.split(s).join('<span style="color: red">'+s+"</span>"),i.title=a.split(s).join('<span style="color: red">'+s+"</span>")}this.model.question(i),this.display_user=t.question.display_user,this.options=$.extend(!0,{},t.options),this.optionsForAnswer={urls:t.options.urls,actions:{"delete":$.proxy(this.getAnswer,this)},state:{showAcceptIcon:!1,showAcceptBtn:!1}},this.options.showAcceptIcon=!1,this.options.showAcceptBtn=!1,this.userId=t.userId,this.actions=this.options.actions||{detail:void 0,"delete":void 0,edit:void 0},this.urls=this.options.urls||{api:"",gateway:""},this.store={getQuestion:function(e){return $.ajax({url:n.urls.gateway+"/v1/questions/"+e,dataType:"json",cache:!1})},deleteQuestion:function(e){return $.ajax({url:n.urls.gateway+"/v1/questions/"+e,dataType:"json",type:"DELETE"})},createAnswer:function(e){return $.ajax({url:n.urls.gateway+"/v1/answers",data:JSON.stringify(e),dataType:"json",type:"POST"})},getAnswer:function(e){return $.ajax({url:n.urls.gateway+"/v1/answers/search",data:e,dataType:"json",cache:!1})},toggleFollowQuestion:function(e,t){return $.ajax({url:n.urls.gateway+"/v1/questions/"+e+"/follow",type:t?"POST":"DELETE"})}},this.init()}function n(t){var n=this;this.model={question:null,answer:null,filter:{page_no:0,page_size:5},answers:{items:[],total:0},state:{showAnswerArea:!1,showAcceptIcon:!1!==t.options.showAcceptIcon,showAcceptBtn:!1!==t.options.showAcceptBtn},content:"",shouldShowAnswerDialog:!1,replayContent:"",replays:[]},this.parent=t.parent,this.model=e.mapping.fromJS(this.model),this.model.question(t.question),this.model.answer(t.answer),this.display_user=t.answer.display_user,this.options=t.options,this.userId=t.userId,this.actions=this.options.actions||{accept:void 0,"delete":void 0},this.urls=this.options.urls||{api:"",gateway:""},this.store={acceptAnswer:function(e,t){return $.ajax({url:n.urls.api+"/v1/answers/"+e+"/actions/accept/"+t,dataType:"json",type:"PUT"})},toggleLikeAnswer:function(e,t){return $.ajax({url:n.urls.gateway+"/v1/answers/"+e+"/like",dataType:"json",type:t?"POST":"DELETE"})},addReplay:function(e){return $.ajax({url:n.urls.gateway+"/v1/replies",type:"POST",data:JSON.stringify(e),contentType:"application/json",dataType:"json"})},getReplayList:function(){return $.ajax({url:n.urls.gateway+"/v1/replies/search?answer_to_id="+n.model.answer().id,type:"GET",contentType:"application/json",dataType:"json"})}},this.init()}function i(t){if(!(this instanceof i))return new i(t);var n=this;this.width=e.observable(0),this.height=e.observable(0);var s=new Image;s.onload=function(){n.width(s.width),n.height(s.height)},s.src=t,this.instance=s}function s(t){this.model={isShow:e.observable(!1),imageArr:e.utils.arrayMap(t.imageArr||[],i),current:e.observable(t.current||0)},this.openGallay=function(e){this.model.current(e),this.model.isShow(!0)},this.closeGallay=function(){this.model.isShow(!1)},this.prev=function(){var t=(e.unwrap(this.model.imageArr).length,e.unwrap(this.model.current));t>0&&(t-=1,this.model.current(t))},this.next=function(){var t=e.unwrap(this.model.imageArr).length,n=e.unwrap(this.model.current);n<t-1&&(n+=1,this.model.current(n))}}e="default"in e?e["default"]:e;var o={alert:function(e){($.fn.udialog&&$.fn.udialog.alert||window.alert)(e,{title:i18nHelper.getKeyValue("courseLearnQuestion.hint"),buttons:[{text:i18nHelper.getKeyValue("courseLearnQuestion.confirm")}]})},confirm:function(e,t){($.fn.udialog&&$.fn.udialog.confirm||window.confirm)(e,[{text:i18nHelper.getKeyValue("courseLearnQuestion.confirm"),click:function(){t&&t(),$(this).udialog("hide")}},{text:i18nHelper.getKeyValue("courseLearnQuestion.cancel"),click:function(){$(this).udialog("hide")}}],{title:i18nHelper.getKeyValue("courseLearnQuestion.hint")})}},a=i18nHelper.getKeyValue;t.prototype.init=function(){var e=this;this.dot(),this.options.actions.accept=function(){e.getQuestion()}},t.prototype.formatTime=function(e){return e&&e.split(".")[0].replace("T"," ")},t.prototype.getQuestion=function(){var e=this;return this.store.getQuestion(this.model.question().id).done(function(t){t.display_user=e.display_user,e.model.question().accepted_answer_id(t.accepted_answer_id),e.model.question().answer_count(t.answer_count),e.dot(),e.getAnswer()})},t.prototype.getAnswer=function(){var t=this,n=this.model.filter,i=e.toJS(this.model.filter),s=this.model.question;i.question_id=s().id,this.store.getAnswer(i).done(function(e){t.model.answers.items(e.items||[]),t.model.answers.total(e.total||0),s().answer_count(e.total||0),$("#pagination_"+t.model.question().id).pagination(e.total,{items_per_page:n.page_size(),num_display_entries:5,current_page:n.page_no(),is_show_total:!1,prev_text:"courseComponent.front.courseDetail.prev",next_text:"courseComponent.front.courseDetail.next",callback:function(e){e!=n.page_no()&&(n.page_no(e),t.getAnswer())}})})},t.prototype.searchAnswer=function(){this.model.filter.page_no(0),this.getAnswer()},t.prototype.toggleAnswerArea=function(){var e=this.model.state.showAnswerArea;e(!e()),e()&&this.searchAnswer()},t.prototype.questionDetail=function(){this.actions.detail&&this.actions.detail(this.model.question())},t.prototype.deleteQuestion=function(){var e=this;o.confirm(a("courseLearnQuestion.confirmDelete"),function(){e.store.deleteQuestion(e.model.question().id).done(function(t){e.actions["delete"]&&e.actions["delete"](e.model.question())})})},t.prototype.editQuestion=function(e){this.actions.edit&&this.actions.edit(e)},t.prototype.toggleFollow=function(){var t=this,n=e.unwrap(this.model.question),i=n.id,s=n.is_current_user_follow;this.store.toggleFollowQuestion(i,!s).done(function(){n.is_current_user_follow=!s,t.model.question(n)})},t.prototype.answer=function(){var e=this;if(this.model.content()){if(this.model.content().length>2e3)return void o.alert(a("courseLearnQuestion.maxLength"));var t={question_id:this.model.question().id,title:"",content:this.model.content()};this.store.createAnswer(t).done(function(t){e.model.content(""),e.getAnswer()})}},t.prototype.toggleMoreContent=function(e){this.model.state.showMoreContent(e),e?$("#question_"+this.model.question().id+" .qa-item-cont").trigger("destroy"):$("#question_"+this.model.question().id+" .qa-item-cont").dotdotdot({height:42,after:".toggle"}).removeClass("expand")},t.prototype.dot=function(t,n){var i=this;e.tasks.schedule(function(){function e(e){e.dotdotdot({height:42,after:".toggle"}).removeClass("init").removeClass("expand");var t=e.find("i.icon.xclq-icon-down-arrow");"inline"===t.css("display")&&t.css("display","inline-block")}function t(e){e.addClass("init expand").trigger("destroy")}var n=$("#question_"+i.model.question().id+" .qa-item-cont");n.on("click",".xclq-icon-down-arrow",function(){t($(this).parents(".qa-item-cont"))}).on("click",".xclq-icon-up-arrow",function(){e($(this).parents(".qa-item-cont"))}),e(n)})},e.components.register("x-course-learn-question",{viewModel:t,template:'<div class="x-course-learn-question qa-item expand" data-bind="attr:{\'id\':\'question_\'+model.question().id}">\r\n    <div class="qa-record">\r\n        <div class="qa-item-avtor">\r\n            <img data-bind="attr:{\'src\':display_user.icon+\'&defaultImage=1\',\'alt\':display_user.display_name}">\r\n        </div>\r\n        <div class="qa-item-main">\r\n            <a class="qa-item-title" href="javascript:void(0);"\r\n               data-bind="html:model.question().title,click:questionDetail"></a>\r\n            <p class="qa-item-source"\r\n               data-bind="translate:{\'key\':\'courseLearnQuestion.from\',properties:{\'from\':model.question().target_name || \'\'}},visible:model.question().target_name"></p>\r\n            <div class="qa-item-cont init">\r\n                <span data-bind="html: model.question().content"></span>\r\n                <span class="toggle">\r\n                    <i class="icon xclq-icon-down-arrow"></i>\r\n                    <i class="icon xclq-icon-up-arrow"></i>\r\n                </span>\r\n            </div>\r\n            \x3c!-- ko if:model.question().attach_pictures&&model.question().attach_pictures.length > 0 --\x3e\r\n            <div data-bind="component: { name: \'x-course-learn-image-gallery\', params: { \'imageArr\': model.question().attach_pictures } }"></div>\r\n            \x3c!-- /ko --\x3e\r\n            <p class="qa-item-author">\x3c!--ko text:model.question().display_user.display_name--\x3e\x3c!--/ko--\x3e&emsp;\r\n                \x3c!--ko text:$component.formatTime(model.question().create_time)--\x3e\x3c!--/ko--\x3e</p>\r\n            <div class="qa-item-opts opts">\r\n                <div class="fl opt">\r\n                    <a href="javascript: void(0);" class="opt" data-bind="click:toggleAnswerArea">\r\n                        <i class="xclq-icon-reply"></i>\r\n                        <em data-bind="translate:{\'key\':model.state.showAnswerArea()?\'courseLearnQuestion.foldAnswerArea\':\'courseLearnQuestion.totalAnswer\',properties:{\'count\':model.question().answer_count}}"></em>\r\n                    </a>\r\n                </div>\r\n                <div class="fl opt" data-bind="click:toggleFollow,visible:model.question().display_user.user_id!=userId">\r\n                    <a href="javascript: void(0);" class="opt" data-bind="style:{\'color\':model.question().is_current_user_follow?\'blue\':\'inherit\'}">\r\n                        <i class="xclq-icon-star"></i>\r\n                        \x3c!--ko translate:{\'key\':\'courseLearnQuestion.followQuestion\'}--\x3e\x3c!--/ko--\x3e\r\n                    </a>\r\n                </div>\r\n                <div class="fr opt" data-bind="visible:model.question().display_user.user_id == userId">\r\n                    <a href="javascript: void(0);" class="trash" data-bind="click:deleteQuestion">\r\n                        <i class="xclq-icon-delete"></i>\r\n                        \x3c!--ko translate:{\'key\':\'courseLearnQuestion.delete\'}--\x3e\x3c!--/ko--\x3e\r\n                    </a>\r\n                    \x3c!--ko if: ko.unwrap(model.question().answer_count) == 0 --\x3e\r\n                    <a href="javascript: void(0);" class="trash" data-bind="click:function(){ editQuestion(ko.unwrap(model.question)) }">\r\n                        <i class="xclq-icon-edit"></i>\r\n                        \x3c!--ko translate:{\'key\':\'courseLearnQuestion.edit\'}--\x3e\x3c!--/ko--\x3e\r\n                    </a>\r\n                    \x3c!-- /ko --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class="qa-reply"\r\n         data-bind="visible:model.state.showAnswerArea() && (model.question().display_user.user_id != userId || model.answers.items().length)">\r\n        <div class="reply">\r\n            <div class="recovery"\r\n                 data-bind="visible:model.question().display_user.user_id != userId">\r\n                <textarea class="recovery-editor" maxlength="2000" data-bind="textInput:model.content"></textarea>\r\n                <div class="recovery-btns">\r\n                    <a href="javascript: void(0);" class="btn fr" data-bind="click:answer,css:{\'disabled\':!model.content().length}">\x3c!--ko translate:{\'key\':\'courseLearnQuestion.answer\'}--\x3e\x3c!--/ko--\x3e</a>\r\n                </div>\r\n            </div>\r\n            <ul class="reply-list" data-bind="foreach:model.answers.items">\r\n                <li>\r\n                    <div data-bind="component:{name:\'x-course-learn-answer\',\r\n                    params:{\r\n                        \'options\': ko.utils.extend($component.options, { showAcceptBtn: $parent.model.question().display_user.user_id == userId&&!ko.unwrap($parent.model.question().accepted_answer_id) }),\r\n                        \'answer\':$data, \r\n                        \'userId\':$component.userId\r\n                    }}"></div>\r\n                </li>\r\n            </ul>\r\n            <div class="pagination" data-bind="attr:{\'id\':\'pagination_\'+model.question().id}"></div>\r\n        </div>\r\n    </div>\r\n</div>'});n.prototype.toggleLikeAnswer=function(){var t=this,n=e.unwrap(this.model.answer),i=n.is_current_user_like;return this.store.toggleLikeAnswer(n.id,!i).done(function(){n.is_current_user_like=!i,n.like_count+=i?-1:1,t.model.answer(n)})},n.prototype.init=function(){},n.prototype.formatTime=function(e){return e&&e.split(".")[0].replace("T"," ")},n.prototype.accept=function(){var e=this;this.store.acceptAnswer(this.model.answer().id,!0).done(function(t){e.actions.accept&&e.actions.accept(e.model.answer())})},n.prototype.showAnswerDialog=function(){var e=this;this.model.shouldShowAnswerDialog(!0),this.store.getReplayList().then(function(t){e.model.replays(t.items)})},n.prototype.hideAnswerDialog=function(){this.model.shouldShowAnswerDialog(!1),this.model.replays([])},n.prototype.handleClickAnswer=function(){var e=this,t={content:this.model.replayContent(),answer_to_id:this.model.answer().id};this.store.addReplay(t).then(function(){e.showAnswerDialog(),e.model.replayContent("")});var n=this.model.answer();n.reply_count=n.reply_count+1,this.model.answer(n)},e.components.register("x-course-learn-answer",{viewModel:n,template:'<div class="x-course-learn-answer reply-item"\r\n     data-bind="css:{\'adopt\':model.answer().accepted || model.state.showAcceptIcon()}">\r\n    <div class="reply-header">\r\n        <div class="reply-avtor">\r\n            <img data-bind="attr:{\'src\':model.answer().display_user.icon+\'&defaultImage=1\',\'alt\':model.answer().display_user.display_name}">\r\n        </div>\r\n        <div class="reply-user">\r\n            <h4 data-bind="text:display_user.display_name"></h4>\r\n            <p class="reply-time" data-bind="text:$component.formatTime(model.answer().create_time)"></p>\r\n        </div>\r\n    </div>\r\n    <div class="reply-body" data-bind="text:model.answer().content"></div>\r\n    <div class="reply-opts opts">\r\n        <div class="fl">\r\n            <a href="javascript: void(0);" class="opt" data-bind="click:$component.showAnswerDialog">\r\n                <i class="xclq-icon-reply"></i>\r\n                <em data-bind="translate: {\'key\': \'courseLearnQuestion.totalReply\', properties:{\'count\': model.answer().reply_count }}"></em>\r\n            </a>\r\n            <a href="javascript: void(0);" class="opt" data-bind="click: toggleLikeAnswer">\r\n                <i class="xclq-icon-like"></i>\r\n                <em data-bind="text: model.answer().like_count"></em>\r\n            </a>\r\n            <a href="javascript: void(0);" class="opt" data-bind="click:accept,visible:model.state.showAcceptBtn">\r\n                <i class="xclq-icon-accept active"></i>\r\n                <em data-bind="translate:{\'key\':\'courseLearnQuestion.accept\'}">采纳答案</em>\r\n            </a>\r\n        </div>\r\n    </div>\r\n    <div class="qaui-mask" data-bind="visible: model.shouldShowAnswerDialog">\r\n        <div class="qaui-pop pop__list">\r\n            <div class="pop__title">\x3c!--ko translate:{\'key\':\'courseLearnQuestion.lookAnswer\'}--\x3e\x3c!--/ko--\x3e\r\n                <span class="pop__close qaicon-close2 qaiconfont" data-bind="click:$component.hideAnswerDialog"></span>\r\n            </div>\r\n            <div class="pop__body">\r\n                <div class="qaui-txta">\r\n                    <textarea class="txta" style="height: 200px" rows="" cols=""  placeholder="写下你的回复..." data-bind="textInput: model.replayContent"></textarea>\r\n                    <div class="txta__oper">\r\n                        <a href="###" class="qaui-btn qaui-btn-main" data-bind="click:$component.handleClickAnswer">\x3c!--ko translate:{\'key\':\'courseLearnQuestion.answer\'}--\x3e\x3c!--/ko--\x3e</a>\r\n                    </div>\r\n                </div>\r\n                <div class="pop__total">\r\n                    <div class="qaui-oper">\r\n                        <span class="qaiconfont qaicon-answer"></span>\r\n                        <span class="oper__text">\r\n                            <em class="num">\x3c!-- ko translate: { key: \'courseLearnQuestion.totalReply\', properties: { \'count\': model.answer().reply_count } } --\x3e\x3c!-- /ko --\x3e</em>\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n                <div class="qacom-list list__answer">\r\n                    <ul class="list__col"  style="overflow-y: auto" data-bind="foreach:model.replays">\r\n                        <li class="list__item">\r\n                            <div class="list__photo">\r\n                                <img data-bind="attr:{\'src\': reply_user_info.icon+\'&defaultImage=1\',\'alt\': reply_user_info.display_name }">\r\n                            </div>\r\n                            <div class="list__wrap">\r\n                                <p class="list__name">\r\n\r\n                                    <span class="name" data-bind="text:reply_user_info.display_name"></span>\r\n                                    <span class="sep">\x3c!--ko translate:{\'key\':\'courseLearnQuestion.answer\'}--\x3e\x3c!--/ko--\x3e</span>\r\n                                    <span class="name" data-bind="text:reply_to_user_info.display_name"></span></p>\r\n                                <p class="list__sub" data-bind="text: create_time.split(\'.\')[0].replace(\'T\', \' \')"></p>\r\n                                <div class="list__con show--more">\r\n                                    <p class="text" data-bind="text:content"></p>\r\n                                </div>\r\n                            </div>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n                \x3c!--<a href="###" class="qaui-load">点击加载更多回答</a>--\x3e\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>'});e.components.register("x-course-learn-image-gallery",{viewModel:s,template:'<div class="x-course-learn-image-gallery">\r\n    <div class="preview">\r\n        <ul>\r\n            \x3c!-- ko foreach: { data: model.imageArr, as: \'item\' } --\x3e\r\n            <li style="display: block; max-height: 200px;overflow: hidden; margin-bottom:3px;font-size: 0;">\r\n                <img class="img" style="width: 200px" data-bind="attr: { src: item.instance.src }, click: $parent.openGallay.bind($parent, $index())">\r\n            </li>\r\n            \x3c!--/ko --\x3e\r\n        </ul>\r\n    </div>\r\n    <div class="detail" data-bind="visible: model.isShow">\r\n        <div class="mask"></div>\r\n        <div class="content">\r\n            <div class="x-prev">\r\n                <div class="arrow-btn qaiconfont qaicon-left" data-bind="click: prev"></div>\r\n            </div>\r\n            <div class="x-next">\r\n                <div class="arrow-btn  qaiconfont qaicon-right" data-bind="click: next"></div>\r\n            </div>\r\n            <div class="images">\r\n                <ul>\r\n                    \x3c!-- ko foreach: { data: model.imageArr, as: \'item\' } --\x3e\r\n                    <li data-bind="visible: $index() === $parent.model.current()" style="position:absolute; top:50%; left: 50%; transform: translate(-50%, -50%); width: 1000px; height: 600px;text-align: center">\r\n                        <img  style="position:absolute; top:50%; left: 50%; transform: translate(-50%, -50%)" data-bind="attr: { src: item.instance.src }, style: { width: ko.unwrap(item.width) > 1000 && ko.unwrap(item.width) > ko.unwrap(item.height) ? \'100%\': \'initial\', height: ko.unwrap(item.height) > 600 && ko.unwrap(item.height)>ko.unwrap(item.width)? \'100%\': \'initial\' }">\r\n                        <div class="close-btn qaiconfont qaicon-close2" data-bind="click: $component.closeGallay.bind($component)"></div>\r\n                    </li>\r\n                    \x3c!-- /ko --\x3e\r\n                </ul>\r\n            </div>\r\n        </div>   \r\n    </div>\r\n</div>'})}(ko);
