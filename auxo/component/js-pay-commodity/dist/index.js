!function(e){"use strict";e=e&&e.hasOwnProperty("default")?e["default"]:e;!function(){function e(e){this.value=e}function n(n){function a(t,o){try{var s=n[t](o),d=s.value;d instanceof e?Promise.resolve(d.value).then(function(e){a("next",e)},function(e){a("throw",e)}):r(s.done?"return":"normal",s.value)}catch(i){r("throw",i)}}function r(e,n){switch(e){case"return":t.resolve({value:n,done:!0});break;case"throw":t.reject(n);break;default:t.resolve({value:n,done:!1})}(t=t.next)?a(t.key,t.arg):o=null}var t,o;this._invoke=function(e,n){return new Promise(function(r,s){var d={key:e,arg:n,resolve:r,reject:s,next:null};o?o=o.next=d:(t=o=d,a(e,n))})},"function"!=typeof n["return"]&&(this["return"]=undefined)}"function"==typeof Symbol&&Symbol.asyncIterator&&(n.prototype[Symbol.asyncIterator]=function(){return this}),n.prototype.next=function(e){return this._invoke("next",e)},n.prototype["throw"]=function(e){return this._invoke("throw",e)},n.prototype["return"]=function(e){return this._invoke("return",e)}}();var n=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},a=function(){function a(r){n(this,a),this.model={order:e.observable(),goodsSnapshots:e.observableArray(),channels:e.observableArray(),selectChannel:e.observable(),payParams:e.observable(),success:e.observable(!1),showQRcodeMask:e.observable(!1)},this.store={getOrder:function(){return $.ajax({url:PAY_SERVICE_URL+"/v2/orders/"+orderId,dataType:"json",cache:!1})},getGoodsSnapshots:function(){return $.ajax({url:PAY_SERVICE_URL+"/v2/orders/"+orderId+"/goods_snapshots",dataType:"json",cache:!1})},getChannels:function(){return $.ajax({url:PAY_SERVICE_URL+"/v1/account/web_channels",dataType:"json",cache:!1})},createOrderVoucher:function(e){return $.ajax({url:PAY_SERVICE_URL+"/v1/orders/voucher",dataType:"json",type:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify(e)})},getOrderStatus:function(){return $.ajax({url:PAY_SERVICE_URL+"/v1/orders/"+orderId+"/status",dataType:"json",cache:!1})}},this.init()}return a.prototype.init=function(){var e=this;$.when(this.store.getOrder(),this.store.getGoodsSnapshots()).then(function(n,a){e.model.order(n[0]),e.model.goodsSnapshots(a[0]),e.store.getChannels().done(function(n){if(n&&n.payment_channel&&n.payment_channel.CHANNEL_CASH){var a=n.payment_channel.CHANNEL_CASH;e.model.selectChannel(a[0]),e.model.channels(a)}})})},a.prototype.handleSelectChannel=function(e){this.model.selectChannel(e)},a.prototype.handlePayClick=function(){this.model.selectChannel()&&this.createOrderVoucher()},a.prototype.formatTime=function(e){return e&&e.split(".")[0].replace("T"," ")},a.prototype.createOrderVoucher=function(){var e=this;this.store.createOrderVoucher({payment_channel:this.model.selectChannel().channel_name,order_id:orderId}).done(function(n){e.model.payParams(JSON.parse(n.pay_params)),e.model.order(),e.syncOrderStatus(orderId)})},a.prototype.syncOrderStatus=function(){var e=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;n>3e5?this.model.showQRcodeMask(!0):this.store.getOrderStatus().done(function(n){n&&(e.model.success(!0),setTimeout(function(){return __return_url&&(location.href=__return_url)},5e3))}).always(function(){setTimeout(function(){return e.syncOrderStatus(n+3e3)},3e3)})},a.prototype.retry=function(){location.reload()},a}();e.components.register("x-pay-commodity",{viewModel:a,template:'\x3c!--ko ifnot:model.success--\x3e\r\n<div class="wrapper" data-bind="if:model.order">\r\n    <div class="container">\r\n        <div class="pay-head"><p data-bind="translate:{\'key\':\'payCommodity.orderInfo\'}">订单信息</p></div>\r\n        <div class="pay-body">\r\n            <ul class="table table-head cf">\r\n                <li data-bind="translate:{\'key\':\'payCommodity.orderId\'}">订单编号</li>\r\n                <li data-bind="translate:{\'key\':\'payCommodity.title\'}">名称</li>\r\n                <li data-bind="translate:{\'key\':\'payCommodity.createTime\'}">下单时间</li>\r\n                <li data-bind="translate:{\'key\':\'payCommodity.price\'}">实付金额</li>\r\n            </ul>\r\n            \x3c!--ko foreach: model.goodsSnapshots--\x3e\r\n            <ul class="table table-body cf">\r\n                <li data-bind="text:order_id">PAY2079431224910890778786529280</li>\r\n                <li data-bind="text:name">MySQL认证（2016.8）</li>\r\n                <li data-bind="text:$component.formatTime($component.model.order().create_time)">2016-01-01 21:19:17\r\n                </li>\r\n                <li data-bind="text:display_settlement_amount">200元</li>\r\n            </ul>\r\n            \x3c!--/ko--\x3e\r\n            <div class="pay-total">\r\n                <div class="pay-total-wrap">\r\n                    <div class="amount"\r\n                         data-bind="translate:{\'key\':\'payCommodity.allTotal\',\'properties\':{\'amount\':model.order().display_amount}}">\r\n                        金额总计：￥45.00\r\n                    </div>\r\n                    <div class="amount"\r\n                         data-bind="translate:{\'key\':\'payCommodity.discountTotal\',\'properties\':{\'amount\':model.order().display_promotion_amount}}">\r\n                        优惠总计：-￥22.00\r\n                    </div>\r\n                    <div class="total"\r\n                         data-bind="translate:{\'key\':\'payCommodity.actuallyTotal\',\'properties\':{\'amount\':model.order().display_settlement_amount}}">\r\n                        应付总额：<strong>￥23.00</strong>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n<div class="wrapper" data-bind="visible:!model.payParams()">\r\n    <div class="container">\r\n        <div class="pay-head"><p data-bind="translate:{\'key\':\'payCommodity.payWay\'}">支付方式</p></div>\r\n        <div class="pay-body">\r\n            <ul class="pay-way cf" data-bind="foreach:model.channels,visible:model.channels().length">\r\n                <li data-bind="css:[channel_name.toLowerCase(),$component.model.selectChannel() === $data && \'active\'].join(\' \'),click:$component.handleSelectChannel.bind($component)">\r\n                    <i class="pay-icon-circle"></i></li>\r\n            </ul>\r\n            <div class="no-pay-way"\r\n                 data-bind="visible:!model.channels().length,translate:{\'key\':\'payCommodity.noPayWay\'}">\r\n                暂时不能支付\r\n            </div>\r\n            <div class="pay-btn-wrap">\r\n                <a href="javascript:;" class="pay-btn"\r\n                   data-bind="css:{\'disabled\':!model.selectChannel()},click:handlePayClick,translate:{\'key\':\'payCommodity.pay\'}">去支付</a><span\r\n                        class="pay-tip" data-bind="translate:{\'key\':\'payCommodity.payHint\'}">下单后，请在24小时内完成支付。超出24小时再支付可能导致购买失败，需重新下单购买。</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n<div class="wrapper" data-bind="if:model.payParams">\r\n    <div class="container">\r\n        <div class="pay-head"><p data-bind="css:model.selectChannel().channel_name.toLowerCase()"></p></div>\r\n        <div class="pay-body">\r\n            <div class="pay-code">\r\n                <div class="code-body">\r\n                    <p data-bind="translate:{\'key\':\'payCommodity.qrCode\'}">二维码</p>\r\n                    <div class="code-img">\r\n                        \x3c!--ko if:model.selectChannel().channel_name === \'CHANNEL_ALIPAY_QR\'--\x3e\r\n                        <div class="iframe-wrap">\r\n                            <iframe height="100%" width="100%" frameborder="no" scrolling="no"\r\n                                    data-bind="attr:{\'src\':model.payParams().data.PayParams}"></iframe>\r\n                        </div>\r\n                        \x3c!--/ko--\x3e\r\n                        \x3c!--ko if:model.selectChannel().channel_name === \'CHANNEL_WECHAT_PUB_QR\'--\x3e\r\n                        <img data-bind="attr:{\'src\':\'http://cloud.101.com/v3/general/qrcode?w=230&h=230&ecl=L&data=\' + model.payParams().data.PayParams}">\r\n                        \x3c!--/ko--\x3e\r\n                    </div>\r\n                    <div class="code-tip"><i class="pay-icon-scan"></i>\r\n                        \x3c!--ko translate:{\'key\':\'payCommodity.scanToPay\'}--\x3e扫描完成支付\x3c!--/ko--\x3e</div>\r\n                    <div class="mask" data-bind="visible:model.showQRcodeMask">\r\n                        <div class="mask-hint">\x3c!--ko translate:{\'key\':\'payCommodity.returnFailed\'}--\x3e返回结果失败，请稍后再试\r\n                            \x3c!--/ko--\x3e\r\n                            <a href="javascript:;" data-bind="click:retry,translate:{\'key\':\'payCommodity.retry\'}"></a>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class="pay-foot"></div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\x3c!--/ko--\x3e\r\n\x3c!--ko if:model.success--\x3e\r\n<div class="wrapper">\r\n    <div class="container">\r\n        <div class="pay-head"><p data-bind="translate:{\'key\':\'payCommodity.orderInfo\'}">订单信息</p></div>\r\n        <div class="pay-body">\r\n            <div class="pay-done">\r\n                <span class="pay-icon-success"></span>\r\n                <p data-bind="translate:{\'key\':\'payCommodity.orderSuccess\',\'properties\':{\'orderId\':model.order().id}}">\r\n                    您的订单<span>EL967811</span>已成功</p>\r\n                <div class="tipcolor"\r\n                     data-bind="translate:{\'key\':\'payCommodity.secondsToReturn\',\'properties\':{\'second\':5}}">\r\n                    <span>5</span>秒后返回商品\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\x3c!--/ko--\x3e'})}(ko);
