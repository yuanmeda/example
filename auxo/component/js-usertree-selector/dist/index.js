!function(e){"use strict";e="default"in e?e["default"]:e;var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=function(){function i(n,o){var r=this;t(this,i),this.element=$(o.element),this.model={readonly:n.readonly||e.observable(!1),selectedList:n.selectedList||e.observableArray([]),selectedShowList:e.observableArray([]),userList:e.observableArray([]),orgId:Number(e.unwrap(n.orgId))||0,orgType:e.unwrap(n.orgType||""),userKeyword:e.observable(""),selectedKeyword:e.observable(""),focusIndex:e.observable(-1),focusSelectedIndex:e.observable(-1),height:e.observable(n.config.height||"690px"),avatarPath:e.observable(n.config.avatarPath),isRadio:e.observable(n.config.isRadio||!1)},this.model.selectedShowList(this.model.selectedList()),this.config=$.extend({initialData:[],host:"",userHost:"",version:"",userVersion:"",projectCode:"",limit:100},n.config),this.curNode=null,this.page=1,this.callbacks=n.callbacks,this.isLoding=!1,this.hasMore=!0,this.treeComponent=null,this.store={getNodes:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"0";return $.ajax({url:r.config.host+"/"+r.config.projectCode+"/"+r.config.version+"/mix_organizations/"+r.model.orgId+"/mix_nodes/"+e+"/children",dataType:"json",cache:!1})},getUser:function(e,t,i){var n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1,o=r.config.limit,s=(n-1)*o,d=r.config.userHost||r.config.host,a=r.config.userVersion||r.config.version,l=i&&i.length>0?d+"/"+r.config.projectCode+"/"+a+"/organizations/"+e+"/orgnodes/"+t+"/users/actions/search?name="+i+"&$offset="+s+"&$limit="+o:d+"/"+r.config.projectCode+"/"+a+"/organizations/"+e+"/orgnodes/"+t+"/users?$offset="+s+"&$limit="+o;return $.ajax({url:l,dataType:"json",cache:!1})}},this.init()}return i.prototype.init=function(){if(this.model.orgId){var e=this;this.initData(this.config.initialData).then(function(t){e.model.readonly()||e.initTree(t)}),this.initObservable()}},i.prototype.initData=function(e){var t=new $.Deferred;return e&&e.length?(t.resolve({org_tree:e}),t.promise()):this.store.getNodes()},i.prototype.initObservable=function(){var e=this;e.model.selectedList.subscribe(function(t){0===e.model.selectedKeyword().length?e.model.selectedShowList(t):t.length!==e.model.selectedShowList().length&&e.querySelected()})},i.prototype.uuid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},i.prototype.transform=function(e){return $.map(e,function(e){return e.isParent=e.isParent||e.is_parent,delete e.children,e})},i.prototype.querySelected=function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.model.selectedKeyword(),t=this.model.selectedList(),i=new RegExp(e),n=t.filter(function(e){return!(!e["org.real_name"].match(i)&&!e.user_id.toString().match(i))});this.model.selectedShowList(n)},i.prototype.addAll=function(){if(!this.model.isRadio()){var e=this.concatList(this.model.selectedList(),this.model.userList());this.model.selectedList(e);var t=this.concatList(this.model.selectedShowList(),this.model.userList());this.model.selectedShowList(t)}},i.prototype.concatList=function(e,t){var i=t.filter(function(t){return-1===e.findIndex(function(e){return e.user_id===t.user_id})});return e.concat(i)},i.prototype.removeAllShow=function(){var e=this.model.selectedShowList(),t=this.model.selectedList().filter(function(t){return-1===e.findIndex(function(e){return t.user_id===e.user_id})});this.model.selectedList(t),this.model.selectedShowList([]),this.model.focusSelectedIndex(-1)},i.prototype.removeAll=function(){this.model.selectedList([]),this.model.selectedShowList([]),this.model.focusSelectedIndex(-1)},i.prototype.addUser=function(){if(!(this.model.isRadio()&&this.model.selectedList().length>0)){var e=this.model.focusIndex();if(e>-1){var t=this.concatList(this.model.selectedList(),[this.model.userList()[e]]);this.model.selectedList(t);var i=this.concatList(this.model.selectedShowList(),[this.model.userList()[e]]);this.model.selectedShowList(i)}}},i.prototype.removeUser=function(){var e=this.model.focusSelectedIndex();if(e>-1){var t=this.model.selectedList(),i=this.model.selectedShowList(),n=i.splice(e,1),o=t.filter(function(e){return e.user_id!==n[0].user_id});this.model.selectedShowList(i),this.model.selectedList(o)}},i.prototype.clickItem=function(e,t){t?this.model.focusSelectedIndex(e()):this.model.focusIndex(e())},i.prototype.onEnterKeydown=function(e,t){var i=e||window.event||arguments.callee.caller.arguments[0];i&&13==i.keyCode&&this.onQuery(t,i.target.value)},i.prototype.onQuery=function(e,t){0===e?(void 0===t&&(t=this.model.userKeyword()),this.clearUserFilter(),this.curNode&&this.getUserList(this.curNode,1,t)):(void 0===t&&(t=this.model.selectedKeyword()),this.querySelected(t))},i.prototype.clearUserFilter=function(){this.model.userList([]),this.page=1,this.isLoding=!1,this.hasMore=!0},i.prototype.getUserList=function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1,i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:this.model.userKeyword(),n=this;this.page=t,this.curNode=e;var o=2===e.node_type?0:e.node_id;this.store.getUser(e.org_id,o,i,t).then(function(e){if(n.isLoding=!1,e.items.length>0){var t=n.model.userList();n.model.userList(t.concat(e.items||[]))}else n.hasMore=!1})},i.prototype.onScrollEvent=function(e,t){var i=$(t.target),n=i.height(),o=i.get(0).scrollHeight;i.scrollTop()/(o-n)>=.85&&!this.isLoding&&this.hasMore&&(this.isLoding=!0,this.getUserList(this.curNode,this.page+1))},i.prototype.initTree=function(e){var t=this.model,i=this,n={async:{enable:!0,url:function(e,t){return i.config.host+"/"+i.config.projectCode+"/"+i.config.version+"/mix_organizations/"+i.model.orgId+"/mix_nodes/"+t.node_id+"/children"},type:"get",dataType:"json",contentType:"applictaion/json",dataFilter:function(e,t,n){return n?i.transform(n):null}},data:{key:{name:"node_name",title:"node_name"},simpleData:{enable:!0,idKey:"id",pIdKey:"parent_id",rootPId:"0"}},callback:{onClick:function(e,t,n){if(!+n.parent_id)return!0;i.clearUserFilter(),i.getUserList(n)},onAsyncSuccess:function(e,n,o,r){if(!t.hasManager){var s=o.children;$.each(s,function(e,t){i.treeComponent.setChkDisabled(t,!0,!1,!0)})}},beforeClick:function(e,t){if(!+t.parent_id)return!1}},view:{fontCss:function(e,t){return t.highlight?{color:"#38adff","font-weight":"bold"}:1===t.node_type?{color:"#767cf3","font-weight":"normal"}:2===t.node_type?{color:"#000","font-weight":"normal"}:3===t.node_type?{color:"#6c6d76","font-weight":"normal"}:void 0},expandSpeed:"normal"}},o=this.element.find(".ztree");o.attr("id","tree-"+this.uuid());this.treeComponent=$.fn.zTree.init(o,n,this.transform(e))},i}();e.components.register("x-userTree-selector",{viewModel:{createViewModel:function(e,t){return new i(e,t)}},template:'<div class="user__selector-layout container-fluid">\r\n    <div class="u__content row-fluid" data-bind="style:{height:model.height}">\r\n        <div class="span4 accordion-group u__box scroll">\r\n            <div class="u__body">\r\n                \x3c!--ko if:model.orgId--\x3e\r\n                <div class="u__tree-selector-component" data-bind="visible:!model.readonly()">\r\n                    <ul class="ztree"></ul>\r\n                </div>\r\n                \x3c!--/ko--\x3e\r\n                \x3c!--ko if:!model.orgId--\x3e\r\n                <p class="u__tree-notfound">请在项目上配置该组织</p>\r\n                \x3c!--/ko--\x3e\r\n            </div>\r\n        </div>\r\n        <div class="span8 u__box-group">\r\n            <div class="u__box-g-i u__box-g-l">\r\n                <div class="accordion-group u__box no-scroll">\r\n                    <div class="u__header">部门成员</div>\r\n                    <div class="u__filter">\r\n                        <div class="u__filter" data-bind="event:{keydown:function(data,event){onEnterKeydown(event,0);return true;}}">\r\n                            <input type="text" placeholder="简称或关键词" data-bind="value: model.userKeyword" />\r\n                            <i class="u__search u__icon-sprite u__icon-search" data-bind="event:{click:function(){onQuery(0)}}"></i>\r\n                        </div>\r\n                    </div>\r\n                    <div class="u__body u__list">\r\n                        <div class="scroll u__list-layout" data-bind="event:{scroll:onScrollEvent}">\r\n                            <ul data-bind="foreach:model.userList">\r\n                                <li>\r\n                                    <div class="u__item" data-bind="css:{\'u__item-focus\':$index() == $parent.model.focusIndex()},click:function(){$parent.clickItem($index,0)}">\r\n                                        <img class="u__avatar" data-bind="attr:{src:$parent.model.avatarPath() + \'/\' + $data.user_id + \'/\' + ($data[\'org.pic\'] || $data.user_id) + \'.jpg?size=80&defaultImage=1\'}"></img>\r\n                                        <span class="u__item-text" data-bind="text:$data[\'org.real_name\'] + \'（\' + $data.user_id + \'）\',attr:{title:$data[\'org.real_name\'] + \'（\' + $data.user_id + \'）\'}"></span>\r\n                                    </div>\r\n                                </li>\r\n                            </ul>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class="u__btn-group">\r\n                <button class="btn btn-default" data-bind="click:addAll, visible:!model.isRadio()">&gt;&gt;</button>\r\n                <button class="btn btn-default" data-bind="click:addUser, attr:{disabled:model.isRadio() && model.selectedList().length > 0}">&gt;</button>\r\n                <button class="btn btn-default" data-bind="click:removeUser">&lt;</button>\r\n                <button class="btn btn-default" data-bind="click:removeAllShow, visible:!model.isRadio()">&lt;&lt;</button>\r\n            </div>\r\n            <div class="u__box-g-i u__box-g-r">\r\n                <div class="accordion-group u__box no-scroll">\r\n                    <div class="u__header">\r\n                        <div>\r\n                            <span>已选人员(<span data-bind="text:model.selectedList().length">0</span>)</span>\r\n                            <a href="javascript:void(0)" data-bind="click:removeAll">全部删除</a>\r\n                        </div>\r\n                    </div>\r\n                    <div class="u__filter">\r\n                        <div class="u__filter" data-bind="event:{keydown:function(data,event){onEnterKeydown(event,1);return true;}}">\r\n                            <input type="text" placeholder="简称或关键词" data-bind="value: model.selectedKeyword" />\r\n                            <i class="u__search u__icon-sprite u__icon-search" data-bind="event:{click:function(){onQuery(1)}}"></i>\r\n                        </div>\r\n                    </div>\r\n                    <div class="u__body u__list">\r\n                        <div class="scroll u__list-layout">\r\n                            <ul data-bind="foreach:model.selectedShowList">\r\n                                <li>\r\n                                    <div class="u__item" data-bind="css:{\'u__item-focus\':$index() == $parent.model.focusSelectedIndex()},click:function(){$parent.clickItem($index,1)}">\r\n                                        <img class="u__avatar" data-bind="attr:{src:$parent.model.avatarPath() + \'/\' + $data.user_id + \'/\' + ($data[\'org.pic\'] || $data.user_id) + \'.jpg?size=80&defaultImage=1\'}"></img>\r\n                                        <span class="u__item-text" data-bind="text:$data[\'org.real_name\'] + \'（\' + $data.user_id + \'）\',attr:{title:$data[\'org.real_name\'] + \'（\' + $data.user_id + \'）\'}"></span>\r\n                                    </div>\r\n                                </li>\r\n                            </ul>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>'})}(ko);
