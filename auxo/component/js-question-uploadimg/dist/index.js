!function(e){"use strict";function i(i){this.model={upload_id:+new Date,attach_pictures:i.attach_pictures||e.observableArray([]),api_url:i.api_url,isShow:i.is_show||e.observable(!0),progress:e.observable(0),message:e.observable(""),filesQueued:e.observableArray([]),hide:e.observable(!1),init:!1},e.options.deferUpdates=!0,this.model.isShow()&&(this.initUpload(),this.model.init=!0),this.model.isShow.subscribe(function(e){e&&(!this.model.init&&this.initUpload(),this.model.init=!0,this.model.attach_pictures().length<9&&this.model.hide(!1))},this)}e=e&&"default"in e?e["default"]:e;var s=i18nHelper.getKeyValue;i.prototype.store={getUploadInfo:function(e){return $.ajax({url:e+"/v1/upload_sessions",cache:!1,dataType:"json"})}},i.prototype.remove=function(e){this.model.attach_pictures.remove(e),this.model.hide(!1)},i.prototype.reset=function(e){this.model.filesQueued.remove(e),this.model.hide(!1)},i.prototype.close=function(){this.model.isShow(!1)},i.prototype.initUpload=function(){this.store.getUploadInfo(this.model.api_url).done($.proxy(function(e){this.uploadInfo=e,this.initPicturePlugin(this.model.upload_id,e)},this))},i.prototype.initPicturePlugin=function(e,i){var s=this.uploader=new WebUploader.Uploader({swf:window.staticUrl+"/auxo/addins/webuploader/v0.1.5/swf/uploader.swf",server:i.server_url+"/upload?session="+i.session,auto:!0,fileVal:"Filedata",threads:9,duplicate:!0,pick:{id:"#"+e,multiple:!0},formData:{path:i.path},fileSingleSizeLimit:3145728,accept:[{title:"Images",extensions:"png,jpg",mimeTypes:"image/png,image/jpeg"}]});s.on("beforeFileQueued",$.proxy(this.beforeFileQueued,this)),s.on("filesQueued",$.proxy(this.filesQueued,this)),s.on("uploadBeforeSend",$.proxy(this.uploadBeforeSend,this)),s.on("uploadError",$.proxy(this.uploadError,this,s,"#"+e)),s.on("uploadSuccess",$.proxy(this.uploadSuccess,this,"#"+e)),s.on("uploadProgress",$.proxy(this.uploadProgress,this,"#"+e)),s.on("error",$.proxy(this.selectError,this,"picture"))},i.prototype.selectError=function(i,o){this.model.filesQueued.removeAll(),"Q_TYPE_DENIED"==o?"picture"==i&&this.model.filesQueued.push({show:e.observable(!0),progress:e.observable(0),message:e.observable(s("qaUploadImg.format"))}):"F_EXCEED_SIZE"==o&&this.model.filesQueued.push({show:e.observable(!0),progress:e.observable(0),message:e.observable(s("qaUploadImg.size"))})},i.prototype.uploadProgress=function(e,i,s){$.each(this.model.filesQueued(),function(e,o){if(o.id==i.id)return o.progress(Math.floor(100*s)),!1}),this.model.filesQueued.valueHasMutated()},i.prototype.beforeFileQueued=function(e){$.each(this.model.filesQueued(),function(i,o){if(o.id==e.id)return 0==e.size&&o.message(s("qaUploadImg.reselect")),o.show(!0),!1})},i.prototype.filesQueued=function(i){if(i.length){var s=i.length,o=9-this.model.attach_pictures().length,t=this;if(s>o){for(var r=o;r<s;r++)this.uploader.removeFile(i[r]);i.length=o}t.model.filesQueued([]),$.each(i,function(i,s){t.model.filesQueued.push({id:s.id,progress:e.observable(0),show:e.observable(!0),message:e.observable()})}),i.length+this.model.attach_pictures().length===9?this.model.hide(!0):this.model.hide(!1)}},i.prototype.uploadError=function(e,i,o,t){this.uploaderMap=this.uploaderMap||{},this.uploaderMap[i]=this.uploaderMap[i]||0,++this.uploaderMap[i]<=1?this.store.getUploadInfo(this.model.api_url).done($.proxy(function(i){e.option("server",i.server_url+"/upload?session="+i.session),e.retry()},this)):($.each(this.model.filesQueued(),function(e,i){if(i.id===o.id)return i.message(s("qaUploadImg.fail")),!1}),this.model.filesQueued.valueHasMutated())},i.prototype.uploadBeforeSend=function(e,i,s){i.type=undefined,i.scope=1,s.Accept="*/*",this.model.message("")},i.prototype.uploadSuccess=function(e,i,o){o.code?$.each(this.model.filesQueued(),function(e,t){if(t.id==i.id)return t.message(o?o.message:s("qaUploadImg.fail")),!1}):(this.model.attach_pictures.push({resource_id:o.dentry_id,resource_path:this.uploadInfo.server_url+"/download?dentryId="+o.dentry_id}),$.each(this.model.filesQueued(),function(e,s){if(s.id==i.id)return s.show(!1),!1}))},e.components.register("x-question-uploadimg",{viewModel:i,template:'<div class="qa-upimg-container">\r\n    <div class="qa-upimg-header clearfix">\r\n        <span class="fl"\r\n              data-bind="translate: {key: \'qaUploadImg.tip\', properties:{total: model.attach_pictures().length, last:9 - model.attach_pictures().length }}"></span>\r\n        <a href="javascript:;" class="fr close" data-bind="click: close">&times;</a>\r\n    </div>\r\n    <i class="qa-upimg-icon-triangle"></i>\r\n    <div class="qa-upimg-body clearfix">\r\n        <ul class="qa-upimg-body-imgwarp clearfix">\r\n            \x3c!-- ko foreach: model.attach_pictures --\x3e\r\n            <li class="qa-upimg-item">\r\n                <a href="javascript:;">\r\n                    <div class="image"\r\n                         data-bind="style: {background: \'url(\'+resource_path+\'&size=160) no-repeat center\'}"></div>\r\n                    <div class="masking">\r\n                        <i class="qa-upimg-icon-close" data-bind="click: $component.remove.bind($component)">&times;</i>\r\n                    </div>\r\n                </a>\r\n            </li>\r\n            \x3c!--/ko--\x3e\r\n            \x3c!-- ko foreach: model.filesQueued --\x3e\r\n            <li class="qa-upimg-progress" data-bind="visible: show" style="display: none;">\r\n                <p data-bind="text: message(), visible: message()" style="display: none;"></p>\r\n                <i class="qa-upimg-icon-close" data-bind="click: $component.reset.bind($component)">&times;</i>\r\n                <div class="qa-upimg-progress-bar">\r\n                    <div class="progress" data-bind="style:{width: progress() + \'%\'}"></div>\r\n                </div>\r\n            </li>\r\n            \x3c!--/ko--\x3e\r\n            <li class="qa-upimg"\r\n                data-bind="attr: {id: model.upload_id}, visible: model.attach_pictures().length !== 9 && !model.hide()">\r\n                <i class="qa-upimg-icon-add">+</i></li>\r\n        </ul>\r\n    </div>\r\n</div>'})}(ko);
